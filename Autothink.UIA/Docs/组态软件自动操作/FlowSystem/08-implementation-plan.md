# 实施计划（底层到编排）

## 阶段划分

### P0 现状梳理与资产清单
- 盘点现有 Flow 与 Selector 资产。
- 明确点表字段与输入参数清单。
- 梳理 MFC 自绘区域与坐标需求。
- 输出《资产清单 + 约束确认》文档。

交付物：
- 资产清单表
- 坐标需求清单
- 现有流程拆解表（硬件/变量/程序/通讯）

验收标准：
- 现有流程/弹窗/模块类型形成清单。
- 坐标点位至少列出“必须固定”的区域。
- 已确定输入参数来源与字段定义。

### P1 L0/L1 原子能力规范化
- 固化 Action 原语与参数规范。
- 统一 StepLog 输出字段。
- 保持 STA 单线程与 Session 生命周期不变。
- 建立错误分类与 policy 行为。

交付物：
- Action 规范文档
- StepLog 规范文档
- 错误分类表

验收标准：
- Action 原语有完整参数校验与错误分类。
- StepLog 覆盖所有动作。
- 关键动作具备 retry/fallback 示例。

### P2 UI Profile 体系落地
- Profile Schema 定稿（metadata/anchors/positions/selectors/nav）。
- 校准工具或脚本原型（至少能输出坐标 JSON）。
- 多版本 Profile 加载与切换策略。
- Overlay 合并策略与校验工具。

交付物：
- Profile Schema
- 校准工具原型
- Profile 示例
- Profile 校验器

验收标准：
- 至少 1 个真实版本 Profile 产出。
- Profile 可被运行时解析并用于坐标点击。
- 校验器可检测缺失 anchors/positions。

### P3 Flow DSL 引擎落地
- DSL Schema 定稿（flow/tasks/steps/control）。
- 解析器 + 校验器 + 运行时执行。
- 参数绑定与内置表达式支持。
- 模板展开机制与模板库加载。

交付物：
- DSL 解析器
- DSL 校验器
- DSL 运行时
- 模板加载器

验收标准：
- DSL 驱动一个完整任务成功执行。
- 校验器能发现缺失 selector/参数。
- 模板展开后仍能通过校验。

### P4 编排与状态机层
- 任务图/DAG 执行器。
- 用户选择执行顺序与依赖校验。
- 全局 UI 状态恢复策略。
- Dry-Run 计划输出与断点续跑。

交付物：
- Orchestrator
- 状态机策略模块
- 执行计划导出器

验收标准：
- 用户可从任意任务起步，依赖可自动补齐。
- 异常 UI 可识别并进入处理流程。
- 断点续跑可从 Task 级恢复。

### P5 迁移与固化
- 现有 Flow 迁移为模板/DSL。
- 旧流程保留兼容入口，逐步废弃。
- 验收流程与回放流程形成标准作业。
- 建立模板/流程版本发布流程。

交付物：
- 模板库
- 迁移清单
- 回放方案

验收标准：
- 至少 1 套完整流程全量迁移。
- 回放能力可复现 1 次失败案例。
- 发布流程可输出 Evidence Pack。

## 关键里程碑
- M1：Profile 系统可落地。
- M2：DSL 执行器完成。
- M3：任务图编排完成。
- M4：主流程迁移完成。

## 建议时间安排（可调整）
- P0：1-2 周（资产盘点与参数清单）
- P1：1 周（Action/StepLog/错误规范）
- P2：2-3 周（Profile 校准 + 校验）
- P3：2-3 周（DSL 解析与运行）
- P4：1-2 周（编排与状态机）
- P5：2-4 周（迁移与固化）

## 角色与责任
- 开发：Action/DSL/Orchestrator 实现。
- 运维：Profile 校准与版本管理。
- 配置人员：模板与流程组合。

## 风险与对策
- 坐标漂移：引入 Profile 版本与校准工具。
- UI 变化：多策略 selector + fallback。
- 流程复杂：模板复用 + 子流程。
- 现场误操作：提供 Dry-Run 与依赖提示。
- 规则变更频繁：参数映射与模板版本化。
