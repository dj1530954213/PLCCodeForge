Project Hollysys: ICS Protocol Reverse Engineering Rule Map

文档版本: v1.3 (V026 Strict, Cleaned)
最后更新: 2026-01-20
当前状态: 规则已纠正, 仍需 golden dump 校验基类链
目标模块: dllDPLogic.dll + AppData.dll + mfc100.dll

1. 已确认的核心事实
1.1 SerializeVersion 固定为 0x26
- CAppGlobalFunc::SetSerilizeVersion(0x26) 只赋值全局变量
- 运行环境 ver=0x26, 所有 >=0x27/0x36/0x39 分支不执行

1.2 MFC 字符串规则必须使用 AfxReadStringLength
- 不是简单的 “len<255 / 0xFF+u16”
- 必须支持 u8 / u16 / u32 三档长度
- 必须支持 Unicode 标记 [0xFF][0xFFFE]

1.3 列表 Count 位宽不统一
- mapping_count: u16
- order_count/channel_count: u32
- 其他列表以 Serialize 代码为准

2. 对象流的基本约束
2.1 调用链为 obj->Serialize(ar)
- 不包含 CRuntimeClass 对象头
- payload 必须从该类 Serialize 期望的第一个字段开始

2.2 基类链必须先序列化
- 至少包含 CDevice
- 可能包含 CModule/CChannel 等中间基类
- 未经 golden dump 验证前, 基类链字段只能标为“候选”

3. MFC 字符串序列化规范 (AfxReadStringLength)
3.1 ANSI/MBCS (GBK)
- len < 0xFF: [u8 len] + bytes
- 0xFF <= len < 0xFFFE: [0xFF][u16 len] + bytes
- len >= 0xFFFE: [0xFF][0xFFFF][u32 len] + bytes

3.2 Unicode (UTF-16LE)
- 前缀 [0xFF][0xFFFE] 表示 Unicode 模式
- 长度规则同 3.1
- 内容为 len 个 u16

4. CModbusSlave::Serialize (ver=0x26) 字节流顺序
4.1 总体顺序 (基类链之后)
1) u8 field_A
2) u32 field_B
3) u32 field_C
4) u32 field_D
5) u32 field_E
6) u32 field_F
7) flags: u8 x4
8) mapping_count: u16
9) mappings: MappingItem * count
10) order_count: u32
11) orders: CModbusOrder * count
12) channel_count: u32
13) channels: CModbusChannel * count
14) extra_len: u16 (ver>=0x17, 0x26 必走)
15) extra_data: bytes

4.2 ver=0x26 下禁用的分支
- ver>=0x39: 不执行
- ver>=0x36 && appver==4: 不执行

5. CModbusOrder::Serialize (ver=0x26) 要点
- ver>=0x16: start_addr/length 为 u32
- ver>=0x27/0x2C/0x30: 不执行
- Order 内部映射列表 count 多为 u32 (需按代码确认)

6. CModbusChannel::Serialize 要点
- 核心字段: u32 offset_val, u8 data_type, u8 bit_offset
- 仍需完整基类链的流布局确认

7. MappingItem 结构 (稳定)
- u32 p1
- u16 p2
- u8  p3
- u16 p4
- u32 blob_len
- blob_len 字节 blob
注意: blob_len 必须等于实际长度

8. 证据: empty_slave.bin (空对象序列化)
8.1 起始为一串 CString (短字符串)
- 包含 "1", "128.0.0.249", "129.0.0.249", "503" 等
- 这些字符串的语义仍需“改值再 dump”对照

8.2 后续出现固定 u32 块
- 0x00000000, 0x00000001, 0xFFFFFFFF, 0xFF000000 等
- 用于校验基类链与字段顺序

9. 待验证清单 (必须用 golden dump 完成)
9.1 CDevice/CModule/CChannel 基类链字段顺序
- Name/ID/Flags/Description 是否紧邻
- 是否存在 padding 或额外字段

9.2 Order/Channel 的语义命名
- 需要“非空样本”来对齐字段含义

10. 实施建议 (Rust 侧)
- 分版本实现: ModbusSlaveV026 / ModbusOrderV026 / ModbusChannelV026
- 不要写 ver>=0x27/0x39 字段
- 字符串前缀必须走 AfxReadStringLength 规则
- Count 位宽必须与 Serialize 代码一致
