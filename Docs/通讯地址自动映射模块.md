# 通讯地址采集并生成模块整体设计思路（现场核对 + 点表导出）

> 本文描述“通讯地址采集并生成”模块：用于在现场或按固定规律，对通讯变量进行批量读取/写入测试、核对地址正确性，并生成可交付的通讯点表与采集程序。  
> 核心目标：**可配置、可批量、可验证、可导出、可回填**。

---

## 1. 业务目标与产物

### 1.1 业务目标
- 支持 485 与 TCP 两类通讯连接参数配置
- 支持对大量变量进行批量采集/显示/验证（读/写/质量位）
- 支持字节序与数据类型正确解析（现场最常见错误来源）
- 支持点位语义绑定（点位名、描述、单位、范围、读写属性）
- 输出“可交付结果”：
  - 通讯地址表（xlsx）
  - 采集结果/测试报告（可选）
  - 采集程序/采集配置（用于复测与交付）

### 1.2 产物类型
- **通讯配置**：连接参数 + 批量采集计划（poll plan）
- **通讯点表**：点位名/描述/地址/类型/字节序/读写属性/设备归属
- **采集结果**：时间序列/最新值/质量/异常（超时、解析失败）
- **采集程序**：可导入或可运行的采集方案（形式按后续落地选择）

---

## 2. 总体架构：core + drivers + exporters（建议）

### 2.1 分层
- **comm_core（稳定）**
  - 点位模型（AddressSpec、DataType、Endian、RW、Scale）
  - 采集计划模型（BatchReadPlan、Schedule、RetryPolicy）
  - 采集执行编排（并发、分批、节流、超时）
  - 值解析与编码（bytes -> typed value；typed value -> bytes）
  - 统一错误与统计（ReadTimeout/DecodeError/WriteFail）
- **drivers（变化：协议/设备）**
  - `driver-modbus-rtu`（典型 485）
  - `driver-modbus-tcp`（典型 TCP）
  - 未来可扩：S7、EtherNet/IP、OPC UA 等
- **exporters（变化：导出形态）**
  - xlsx exporter（点表/结果表）
  - json exporter（中间数据）
  - “采集程序生成器”（面向交付）

> 规则：协议差异/设备差异只在 driver；导出格式差异只在 exporter；core 只做采集编排与模型。

---

## 3. 数据模型设计（核心）

### 3.1 点位与地址模型（建议字段）
- `PointId`：全局唯一（可用 点位名 或 name+device 组合）
- `Name` / `Description`
- `DeviceRef`：设备/站号/柜号/区域
- `Protocol`：RTU/TCP（未来可扩）
- `AddressSpec`
  - 站号/单元
  - 功能码/区（如 holding/input/coil/discrete）
  - 起始地址 + 长度（bit/word）
- `DataType`
  - Bool/Int16/UInt16/Int32/UInt32/Float32/Float64/String…
- `Endian`
  - ByteOrder（ABCD/DCBA/…）+ WordSwap 规则
- `RW`：R/W/RO/WO
- `Scale`：倍率/偏移/单位（可选）

### 3.2 批量采集计划（Batch Read Plan）
- “灵活配置批量读取”的落地方式：
  - 按设备分组（同站号/同连接）
  - 按地址连续性聚合（减少请求次数）
  - 每组设置周期、超时、重试、并发上限
- 输出：可执行的 `ReadJobs[]`（每个 job 对应一次协议请求）

---

## 4. 执行与性能：并发、节流、确定性

### 4.1 执行模型
- Session（连接）级别：串行/有限并发（视协议与设备能力）
- Job（请求）级别：队列 + 限速（避免把 PLC/网关打挂）
- 结果汇总：按点位稳定排序输出（利于回填与对比）

### 4.2 超时与重试
- 每个 job：timeout + retry policy
- 对“偶发失败”与“持续失败”区分统计（现场定位重要）

---

## 5. 显示与绑定：从采集到“点表回填”

### 5.1 采集显示
- 实时值：最新值 + 质量（OK/Timeout/DecodeError）
- 诊断信息：最后一次请求耗时、失败原因、重试次数

### 5.2 绑定与回填（关键）
- 允许用户把“采集到的地址/解析规则”绑定到工程点位（Name/Desc）
- 支持把确认后的地址规则回填到“统一点位真实数据源”
  - 与联合 xlsx 的 PointId 对齐（name 或 name+device）
  - 形成最终可用于 PLC 生成与自动化导入的地址表

---

## 6. 导出设计：点表 xlsx + 中间数据

### 6.1 xlsx 点表导出（必须）
- Sheet: `Points`
  - PointId/Name/Desc/Device/Protocol/Address/DataType/Endian/RW/Unit/Scale
- Sheet: `ReadPlan`（可选）
  - 分组策略/批次/周期/超时/重试
- Sheet: `Results`（可选）
  - 最新值/质量/最后采集时间/错误

### 6.2 中间数据导出（强建议）
- JSON/YAML：用于后续合并与自动化消费
- 使通讯采集模块能够被“脚本化/批处理化”

---

## 7. 与其它模块的接口（数据交接）

### 7.1 与联合 xlsx（IO+设备表）
- 从联合 xlsx 获取：
  - 点位清单（PointId/Name/Desc/Device）
  - 期望的通讯字段（若有）
- 通讯采集模块输出：
  - 经核对后的 AddressSpec/DataType/Endian 等，回填到统一点位源

### 7.2 与 PLC Generator
- PLC 生成消费“统一点位真实数据源”
- 通讯采集输出的地址表应能合并成 ImportResult 等价结构

### 7.3 与 UIA 自动化
- UIA 自动化可被用于：
  - 在目标组态软件里导入“采集程序”
  - 或导入采集点表/变量表后进行编译验证（按目标软件适配器实现）

---

## 8. MVP 实施路径（建议）
1) 点位模型 + 连接配置（485/TCP）+ 基础读取（小规模）  
2) 批量读取计划（分组/聚合/节流）+ 数据类型/字节序解析  
3) 绑定点位语义 + 导出 xlsx 点表  
4) 写入验证/采集结果报告 + 采集程序生成（按交付要求落地）

---
