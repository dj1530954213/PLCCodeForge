# 通讯采集一键演示（Import → Run(Mock) → Export Delivery）

本 Runbook 用于现场/验收时快速演示“联合导入 → 采集运行（Mock）→ 交付导出”的闭环，且保证：
- **command 不阻塞 UI**（start/stop/latest/export 全部 spawn/缓存/spawn_blocking）
- **默认 mock**（不依赖真实 PLC/不依赖本机开放端口）
- **交付版通讯地址表.xlsx 三张冻结表必然存在**，并且 **Results 必然 written（runLatest 传入）**

---

## 1. 环境准备

在仓库根目录执行：

```bash
pnpm install
pnpm build

cargo build --manifest-path src-tauri/Cargo.toml
cargo test --manifest-path src-tauri/Cargo.toml
```

开发启动（打开桌面窗口）：

```bash
pnpm tauri dev
```

---

## 2. 操作步骤（UI）

1) 打开应用后，左侧菜单进入：`通讯采集` → `联合导入`
2) 填写：
   - `文件路径`：联合 xlsx 文件路径（例如 `C:\temp\联合点表.xlsx`）
   - `strict 校验`：建议保持开启（可更早发现 sheet/列名/枚举问题）
   - `Sheet 名`：默认 `联合点表`
   - `地址基准`：默认 `one（Excel 1 -> 内部 0）`
   - `交付目录 outputDir`：默认 `AppData/<app-name>/comm/deliveries/`（可改为任意可写目录）
   - `导出路径`：可留空（将自动导出到 `outputDir/xlsx/通讯地址表.<ts>.xlsx`）；也可手填 `C:\temp\通讯地址表.xlsx`
3) 点击：`一键演示（Wizard）`
4) 在页面下方查看：`流水线日志（验收用）`
5) 确认页面提示：`CommIR 已导出`（可点击 `打开 IR`）
6) 点击：`导出 PLC Bridge（v1）`，页面会显示 `PLC Bridge 已导出：...`（默认导出到 `outputDir/bridge/`）
7) 点击：`运行 bridge consumer check`，页面会显示 `bridge_check 已生成：.../summary.json`（默认导出到 `outputDir/bridge_check/<ts>/summary.json`）
8) 点击：`导出 ImportResultStub（v1）`，页面会显示 `ImportResultStub 已导出：...`（默认导出到 `outputDir/bridge_importresult_stub/`）
9) （可选）点击：`导出证据包`，用于现场回传 evidence（包含日志/导出响应/manifest/可选冲突报告/可选 xlsx/ir/bridge/stub 拷贝 + evidence.zip）

---

## 3. 预期结果（可验收）

### 3.1 UI 侧预期

流水线日志应按顺序出现（每步 ok/error 都可见）：
- `import`：导入成功
- `map`：映射完成（含 pointKey 复用统计）
- `save`：points/profiles 落盘成功
- `run_start`：拿到 `runId`
- `latest`：**至少出现 OK/Timeout/DecodeError 中任意两种**（演示使用 mock 的 channelName 关键字稳定触发）
- `export`：导出成功，且 `resultsStatus=written`

### 3.2 导出文件预期

打开导出的 `通讯地址表.xlsx`，必须存在以下三张 sheet（列名/顺序冻结）：
- `TCP通讯地址表`
- `485通讯地址表`
- `通讯参数`

并且本演示会附加 Results（第 4 张）：
- `采集结果`（因为导出使用 `resultsSource=runLatest`，且 resultsStatus 必须为 written）

### 3.3 证据包（可选）

点击 `导出证据包` 后，UI 会显示 evidence 输出位置（固定在 outputDir 下）：
- `outputDir/evidence/<ts>/...`
- 并包含 `evidence.zip`（可直接打包回传）

### 3.4 Bridge / bridge_check（合并前可消费验证）

UI 导出 PLC Bridge 后，默认落盘：
- `outputDir/bridge/plc_import_bridge.v1.<ts>.json`

UI 运行 bridge consumer check 后，默认落盘：
- `outputDir/bridge_check/<ts>/summary.json`

UI 导出 ImportResultStub 后，默认落盘：
- `outputDir/bridge_importresult_stub/import_result_stub.v1.<ts>.json`

---

## 4. 常见失败排查（重点：resultsStatus=missing）

如果导出返回 `resultsStatus=missing`，常见原因：
1) `includeResults=true` 但 `resultsSource=runLatest` 时 **没有传入 results** 或 results 为空：
   - 例如 runId 无效/采集未产出 latest 就停止
2) `resultsSource=appdata` 但 `AppData/<app-name>/comm/last_results.v1.json` 不存在：
   - 说明还未执行过 stop 落盘或本机 AppData 被清理

建议检查：
- 流水线日志是否出现 `latest: results>0`
- 导出日志行是否显示 `resultsStatus=written`
