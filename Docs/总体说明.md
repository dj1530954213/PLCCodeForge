# PLC 自动编程工具集：现状理解与整体汇总（修正版：澄清 AutoThink 的含义）

> 目标：把“点位数据 → PLC 程序/变量 → 在厂家组态/编程软件中可导入/可粘贴/可编译”的交付闭环做成**可组合工具集**。  
> 当前三块能力并行建设：**通讯采集**、**组态软件 UI 自动化（UIA 自动操作）**、**PLC 程序自动编辑**；后期合并为一个整体，但允许用户按需搭配使用。

---

## 0. 关键术语澄清

- **AUTOTHINK**：指 *和利时* 的 PLC 编程/组态软件（目标被操作对象）。
- **UIA 自动操作模块**：我们开发的“自动化执行能力”，通过 UI Automation（UIA/FlaUI）去**操作目标组态软件**（例如 AUTOTHINK、Logix 5000、TIA Portal/博图等）。
- **品牌差异 vs 软件差异**
  - *PLC 品牌差异*：影响模板/变量结构/剪贴板协议（在 PLC 生成链路的 brand adapter 里解决）。
  - *组态软件差异*：影响 UI 结构与操作流程（在 UIA 自动化的“软件适配器”里解决）。

---

## 1. 系统三大部分与边界

### 1) 通讯地址采集并生成（Comm Acquisition）
**定位**：在现场或按固定规律，对通讯变量进行实际读取/核对/测试，形成“真实可用的通讯地址与数据映射”，并支持导出点表（xlsx）。

**核心能力**
- 连接参数配置
  - 485：波特率、校验、站号等
  - TCP：IP、端口、站号/单元标识等
- 变量采集与显示
  - 灵活配置批量读取（分组、分页、周期）
  - 字节序/数据类型展示（endianness、bit/word、float/int 等）
  - 为地址绑定点位名与描述（与工程语义对齐）
  - 生成点位配置中间数据，并导出为 xlsx 点表（现场交付/回填）

> 产物关键词：**通讯地址表 / 采集结果表 / 采集程序（用于交付或复测）**

---

### 2) 组态软件 UI 自动化（UIA Automation：适配 AUTOTHINK/Logix5000/博图等）
**定位**：把“交付物”和“工程配置动作”自动送入**目标组态软件**，完成工程配置与导入/粘贴/编译等操作；并以“适配器方式”支持多种组态/编程软件。

#### 2.1 原子操作（UIA 基础动作）
1. 查找元素（窗口/树/表格/按钮/编辑器）
2. 在元素或区域右键显示菜单
3. 单击/双击选定元素
4. 点击按钮
5. 在文本框输入指定值
6. 执行 CTRL+V（粘贴）

#### 2.2 组合能力（流程动作）
- 添加硬件信息
- 配置通讯模版信息
- 导入变量表
- 创建子程序
- 导入程序
- 编译

> 产物关键词：**自动化脚本/步骤日志、可重放流程、执行结果报告**

#### 2.3 “适配不同组态软件”的架构要求（核心调整点）
我们开发的不是“名为 AUTOTHINK 的自动化软件”，而是一个 **UIA 自动化引擎 + 多组态软件适配器** 的结构：

- **u ia_core（稳定）**：提供通用能力
  - 元素定位、等待条件、超时与重试策略
  - 基础动作（点击、输入、右键、粘贴）
  - 统一错误分类与步骤日志（便于现场定位）
- **uia_adapters（变化）**：按“目标组态软件”拆分适配器
  - `uia-autothink`：和利时 AUTOTHINK 的 UI 结构与操作路径
  - `uia-logix5000`：Rockwell Logix 5000 的 UI 结构与导入流程
  - `uia-tiaportal`：西门子 TIA Portal（博图）的 UI 结构与操作流程
- **apps（组合根）**：选择具体“目标组态软件适配器”并装配执行

> 关键工程规则：  
> - UIA 自动化主流程不写 `if software == ...` 的分支；差异全部进入适配器。  
> - 新增一个组态软件 = 新增一个适配器 + 少量组合根注册，不改稳定核心。

---

### 3) PLC 程序自动编辑（PLC Generator）
**定位**：把点表解析为统一数据源 → 按模板生成程序/变量交付物 → 通过文件/剪贴板/内存等渠道交付；支持多 PLC 品牌、可扩展、可回归。

**核心架构（六边形 / Ports & Adapters）**
- **plc_core（稳定）**：领域模型 + ports 契约 + 单一入口 orchestrate 编排
- **plc_adapters（可替换）**：Excel 导入、模板引擎、Windows 交付、品牌差异（pre/post/retrieve/codec）
- **apps（组合根）**：品牌选择、路径、并发、模板根目录等装配配置

**稳定主链路（一次生成闭环，4 段）**
1. Prepare：品牌预处理 `PreprocessorPort.prepare()`（决定生成哪些任务）
2. Render：模板发现与渲染 `TemplateRegistryPort.get()` + `TemplateRendererPort.render()`（品牌无关）
3. Assemble：品牌后处理 `PostprocessorPort.assemble()`（变成可交付 Bundle/Payload）
4. Deliver：平台交付 `RetrieverPort.deliver()`（文件/剪贴板/内存）

> 产物关键词：**Bundle/Payload、Manifest（签收单）、warnings/statistics、可复现输出**

---

## 2. “完整程序”的点位输入源：两部分（保持不变）

对于一个完整工程的“唯一点位输入源”，由两类数据共同构成：

### A. 用户整理的 IO 表 + 设备表（联合 xlsx）
- 来源：用户维护的 IO 表、设备表等多个工作簿合并成一张表（联合 xlsx）
- 特点：包含工程语义与结构信息，**同时携带部分硬件信息**
- 作用：决定“系统应该有哪些点位/设备、工程结构如何组织、硬件需要如何配置、子程序如何拆分”等

### B. 通讯地址采集并生成（现场核对的通讯地址表）
- 来源：现场采集/测试得到的真实通讯地址与读写可用性验证结果，或依据固定规律生成并核验
- 作用：为最终交付提供“可用的通讯映射”，并支撑采集测试、写入验证与采集程序交付

> 结论：最终“真实数据源”是 **联合 xlsx（工程定义） + 通讯采集表（现场真实）** 的合成视图；两者在数据交接上要能对接，但允许用户自由搭配使用。

---

## 3. 项目整体执行流程（可组合，不强制线性）

### 3.1 常见的一条“推荐路径”（便于理解）
1. **导入联合 xlsx（IO 表 + 设备表）并解析**
2. 使用 **UIA 自动化（目标：AUTOTHINK/Logix5000/博图等）** 完成：
   - 硬件配置
   - 子程序创建
3. **生成 PLC 程序交付产物 + 点表**，并导入目标组态软件
4. 根据实际情况执行 **通讯采集**：
   - 采集测试与写入验证
   - 形成通讯地址表/采集结果
5. 生成 **采集程序** 并完成最终交付

### 3.2 系统允许用户自由组合
- 可以先做通讯采集，再回填点表再生成程序
- 也可以先生成程序与变量导入，后续再做通讯核对与采集程序补交付
- **不把流程写死**：关键是保证数据交接清晰、产物可追溯、自动化步骤可回放

---

## 4. 数据与产物交接：需要“稳定契约”（便于三者合并）

### 4.1 核心中间产物（概念层）
- **Unified Point Source（统一点位真实数据源）**
  - 输入：联合 xlsx（工程定义） + 通讯采集结果（真实核对）
  - 输出：可被 PLC Generator 消费的统一结构（等价于 ImportResult 的抽象层）
- **Bundles（交付物清单）**
  - 程序：ST 文本（Memory/Text）或梯形图/安全程序（Clipboard/Binary）
  - 变量：.xls 文件（File/Binary），少数安全型变量也可能需要 Clipboard/Binary
- **Manifest（签收单 / 审计单）**
  - 使用的模板列表、输出文件路径、剪贴板写入条目、内存输出条目、统计信息、warnings

### 4.2 UIA 自动化模块与交付物的关系（重要）
- UIA 自动化模块**不需要理解 PLC 品牌规则**
- UIA 自动化模块只需要理解“目标组态软件的操作方式”，并消费交付物：
  - 文件导入（.xls）
  - 剪贴板粘贴（binary 已写入系统剪贴板）
  - 文本粘贴/填充（Memory/Text）
- 因此它的变化维度应是“目标软件”而不是“PLC 品牌”

---

## 5. 后期合并时必须守住的架构原则（修正版）

1. **单一真实数据源视图**：联合 xlsx + 通讯采集表最终合并为统一视图（可回填、可审计）
2. **PLC 生成单入口**：PLC 程序生成必须统一走 orchestrate（便于回归、验收、定位）
3. **PLC 品牌差异隔离**：剪贴板协议、变量列结构等只存在于 PLC brand adapter/codec
4. **组态软件差异隔离**：UI 结构/导入路径/菜单位置等只存在于 UIA “目标软件适配器”
5. **平台动作通用化**：写文件/写剪贴板属于平台基础设施能力，避免混入品牌/软件分支
6. **可观测与可回放**
   - PLC 生成侧：manifest + statistics + warnings
   - UIA 自动化侧：步骤日志 + 元素定位证据 + 错误上下文（尽可能可重放）

---

## 6. 当前并行开发的落点（调整后对齐）

### A) 通讯采集：近期交付目标
- 配置连接参数（485/TCP）
- 批量读取与数据显示（字节序/类型）
- 点位绑定（名称/描述/类型/地址）
- 导出 xlsx 点表 + 中间配置数据
- 形成“采集程序”的交付结构（可执行或可导入）

### B) UIA 自动化：近期交付目标（按“目标软件适配器”推进）
- 固化 6 个原子操作 API（稳定、可重试、可定位错误）
- 先完成 `uia-autothink`（和利时 AUTOTHINK）的组合流程闭环：
  - 硬件配置 / 子程序创建 / 导入变量表 / 导入程序 / 编译
- 形成适配器框架后，再拓展 `uia-logix5000`、`uia-tiaportal` 等

### C) PLC 程序自动编辑：近期交付目标
- 落地 orchestrate 主链路（确定性、并发、manifest、错误归类）
- 拆分 template-tera 为 Registry + Renderer 适配器
- 品牌适配器实现最小闭环（pre/post/retrieve + 必要 codec）

---

## 7. 一句话总结（修正版共识）
- **AUTOTHINK 是目标组态软件**；我们做的是 **UIA 自动化引擎 + 多组态软件适配器**  
- **数据来源**：联合 xlsx（工程定义） + 通讯采集表（现场真实）共同构成最终真实数据源  
- **架构底线**：PLC 生成单入口 orchestrate；PLC 品牌差异在品牌适配器；组态软件差异在 UIA 软件适配器；三者可组合使用

---
