# Stage2 当前完成情况（AUTOTHINK 普通型）

本文用于单独记录 Stage 2 的实际完成情况与小范围测试入口，便于后续验收。

## 1. 已完成清单

- Flow 注册与分发骨架已稳定（RunFlow + NotImplemented/InvalidArgument 语义）。
- 4 条 flow 均已实现并注册：
  - autothink.attach
  - autothink.importVariables
  - autothink.importProgram.textPaste
  - autothink.build
- Selector 扩展（NameContains/IgnoreCase）已上线，旧 exact 行为不变。
- Selector 扩展新增：AutomationIdContains / ClassNameContains / NormalizeWhitespace。
- 剪贴板写入能力已内置（SetClipboardText StepLog）。
- StepLog 全链路记录，关键步骤稳定可回放。
- Flow 新增 `searchRoot`（mainWindow/desktop），StepLog 记录 root。
- Stage2Runner 支持 selector profile + 配置化回归脚本。

## 2. 关键能力说明

- importProgram.textPaste：
  - 主路径：SetClipboardText + CTRL+V
  - 失败/验证超时：fallback Keyboard.Type
  - 参数支持 verifyMode/afterPasteWaitMs
- importVariables：菜单/对话框导入，支持主窗口/桌面双根查找。
- build：点击编译 + WaitUntil，可检测 UnexpectedUIState。

## 3. 小范围测试入口（已可测试）

- WinFormsHarness（交互式）
  - `dotnet run --project Autothink.UiaAgent.WinFormsHarness/Autothink.UiaAgent.WinFormsHarness.csproj -c Release`
  - 用于单条 flow 的参数试跑与 StepLog 观察。
- Stage2Runner（自动回归）
  - `dotnet build PLCCodeForge.sln -c Release`
  - `dotnet run --project Autothink.UiaAgent.Stage2Runner/Autothink.UiaAgent.Stage2Runner.csproj -c Release --config Docs/组态软件自动操作/RunnerConfig/demo.json`
  - 读取配置 + profile，顺序跑通 4 条 flow，并输出 StepLog 到 `logs/<timestamp>/`。

## 4. Selector 存放位置

- 统一存放：`Docs/组态软件自动操作/Selectors/`
- 现场录制后仅替换 JSON，不改 flow 代码。
- profile 命名：`<profile>.<flow-suffix>.json`。

## 5. 待办

- 在真实 AUTOTHINK 普通型环境执行 4 条 flow，并保存 StepLog 片段作为验收证据。
- 按 Runbook 提交 `logs/<timestamp>/` 证据目录。
