# 组态软件自动操作（AUTOTHINK 普通型）当前进展总结

本文汇总 UIA 自动操作模块截至当前的完成情况，覆盖 Stage 0/1 与 Stage 2 的最新落地与回归入口。

## 1. 总体状态

- Stage 0/1：uia_core 原子动作 + JSON-RPC 契约已完成，具备可用代码与测试。
- Stage 2：TASK-S2-01~S2-08 已完成代码落地与文档归档，等待真实 AUTOTHINK 普通型环境回归验证。
- Stage 2.1：TASK-S2-09~S2-14 已完成（profile 落地/selector 增强/searchRoot/Runner 配置化/Runbook/基线资产包+summary）。
- Selector 存放位置已统一：`Docs/组态软件自动操作/Selectors/`。

## 2. 已完成内容（关键点）

### 2.1 uia_core（Stage 0/1）
- RPC 入口与 STA 线程模型已固化（stdin/stdout JSON-RPC）。
- 原子动作已覆盖：Find/Click/DoubleClick/RightClick/SetText/SendKeys/WaitUntil。
- 统一返回结构：RpcResult + StepLog + 错误分类。
- Selector 路径式定位，强制每步至少一个过滤条件，避免非确定性匹配。

### 2.2 Stage 2（TASK-S2-01~S2-08）
- 4 个固定 FlowName 已落地：
  - autothink.attach
  - autothink.importVariables
  - autothink.importProgram.textPaste
  - autothink.build
- NotImplemented/InvalidArgument 分发语义已固化，错误码新增 NotImplemented。
- 剪贴板能力：`FlowContext.TrySetClipboardText`（StepId=SetClipboardText）。
- Selector 增量扩展：`NameContains` / `IgnoreCase`（默认 exact 行为不变）。
- 4 条 flow 实现完成并注册：
  - attach（主窗口校验 + 置前）
  - importProgram.textPaste（剪贴板 + CTRL+V，必要时 fallback Type）
  - importVariables（菜单/对话框导入变量表）
  - build（点击编译 + WaitUntil）
- 回归入口：WinFormsHarness + DemoTarget + Stage2Runner。

对应结果记录：
- `Docs/ExecResults/TASK-S2-01-result.md`
- `Docs/ExecResults/TASK-S2-02-result.md`
- `Docs/ExecResults/TASK-S2-03-result.md`
- `Docs/ExecResults/TASK-S2-04-result.md`
- `Docs/ExecResults/TASK-S2-05-result.md`
- `Docs/ExecResults/TASK-S2-06-result.md`
- `Docs/ExecResults/TASK-S2-07-result.md`
- `Docs/ExecResults/TASK-S2-08-result.md`

### 2.3 Stage 2.1（TASK-S2-09~S2-14）
- Selector Profile 文件已落地（`autothink.attach.json` / `autothink.importProgram.textPaste.json` / `autothink.importVariables.json` / `autothink.build.json`）。  
- Stage2Runner 支持 `--selectorsRoot` / `--profile`，并可从配置文件一键回归。  
- Selector 匹配增强：`AutomationIdContains` / `ClassNameContains` / `NormalizeWhitespace`。  
- Flow 支持 `searchRoot`（mainWindow/desktop），StepLog 记录 root。  
- Runbook 已输出：`Docs/组态软件自动操作/Runbook-Autothink-普通型.md`。  
- 基线 selector 资产包已落地，支持 `.local.json` 覆盖；Stage2Runner 生成 `summary.json`。  

对应结果记录：
- `Docs/ExecResults/TASK-S2-09-result.md`
- `Docs/ExecResults/TASK-S2-10-result.md`
- `Docs/ExecResults/TASK-S2-11-result.md`
- `Docs/ExecResults/TASK-S2-12-result.md`
- `Docs/ExecResults/TASK-S2-13-result.md`
- `Docs/ExecResults/TASK-S2-14-result.md`

## 3. 代码落点（关键文件）

- `Autothink.UiaAgent/Flows/Autothink/AutothinkAttachFlow.cs`
- `Autothink.UiaAgent/Flows/Autothink/AutothinkImportProgramTextPasteFlow.cs`
- `Autothink.UiaAgent/Flows/Autothink/AutothinkImportVariablesFlow.cs`
- `Autothink.UiaAgent/Flows/Autothink/AutothinkBuildFlow.cs`
- `Autothink.UiaAgent/Flows/FlowRegistry.cs`
- `Autothink.UiaAgent/Uia/ClipboardText.cs`
- `Autothink.UiaAgent.WinFormsHarness/`
- `Autothink.UiaAgent.DemoTarget/`
- `Autothink.UiaAgent.Stage2Runner/`
- `Docs/组态软件自动操作/Selectors/`

## 4. 已完成证据

- Release 编译通过：
  - `dotnet build PLCCodeForge.sln -c Release`
- Release 测试通过：
  - `dotnet test Autothink.UiaAgent.Tests/Autothink.UiaAgent.Tests.csproj -c Release`
- JSON-RPC / StepLog 证据：见 `Docs/ExecResults/TASK-S2-01-result.md` ~ `TASK-S2-08-result.md`。

## 5. 待办与下一步

- 在真实 AUTOTHINK 普通型环境跑通 4 条 flow 并保存 StepLog 片段。
- 将现场 selector 录制结果写入 `Docs/组态软件自动操作/Selectors/`。
- 使用 Stage2Runner 配置化回归脚本收集 `logs/<timestamp>/` 证据。
- 若回归通过，进入下一阶段（更多流程或其它组态软件适配）。

## 6. 约束提示

- 当前操作范围仅限 C# 项目（Autothink.UiaAgent 相关代码与文档）。
- FlowName 固定且大小写敏感；StepLog 必须完整记录，不允许吞异常。
