âœ… æœ€æ–°å®Œå…¨ç‰ˆ Rule Mapï¼ˆæˆªè‡³ç›®å‰æ‰€æœ‰å·²çŸ¥å†…å®¹æ•´åˆç‰ˆ / å»é‡åˆå¹¶ç‰ˆï¼‰
0) åŸºç¡€é€šç”¨ï¼šArchive / String / Version
0.1 SerializeVersion æ¥æºï¼ˆå·²ç¡®å®šï¼‰
int CAppGlobalFunc::GetSerilizeVersion() { return dword_10208FB4; }


ç»“è®ºï¼š SerializeVersion æ˜¯å…¨å±€ dwordï¼ˆdword_10208FB4ï¼‰ã€‚

0.2 CString åºåˆ—åŒ–é€šç”¨è§„åˆ™ï¼ˆNormal & Safety å…±ç”¨ï¼‰
0.2.1 å†™å…¥é•¿åº¦å¤´ï¼šAfxWriteStringLength(ar, len, isUnicode)

è‹¥ isUnicode!=0ï¼šå…ˆå†™ 0xFF å†å†™ 0xFFFEï¼ˆæ ‡è®°å®½å­—èŠ‚æ¨¡å¼ï¼‰

ç„¶åå†™é•¿åº¦ï¼š

len < 0xFFï¼šå†™ 1 å­—èŠ‚ len

len >= 0xFFï¼šå…ˆå†™ 0xFFï¼Œå†ï¼š

len < 0xFFFEï¼šå†™ 2 å­—èŠ‚ len

len >= 0xFFFEï¼šå†™ 0xFFFFï¼Œå†å†™ 4 å­—èŠ‚ len

len == 0xFFFFFFFF(-1)ï¼šå†™ 4 å­—èŠ‚ -1ï¼Œå†å†™ 4 å­—èŠ‚ -1ï¼ˆå¼‚å¸¸/ç‰¹æ®Šå ä½ï¼‰

0.2.2 å†™å…¥å­—ç¬¦ä¸²å†…å®¹

ä¸åŒ…å« \0

ç©ºä¸²ï¼šé•¿åº¦å¤´ä¸º 0ï¼›æ—  padding

ANSIï¼šå†™ len å­—èŠ‚

UTF-16LEï¼šå†™ len*2 å­—èŠ‚

0.2.3 è¯»å–é•¿åº¦å¤´ï¼šAfxReadStringLength(ar, &mode)

åˆå§‹ *mode=1

å…ˆè¯» 1 å­—èŠ‚ï¼š

è‹¥ != 0xFFï¼šè¿”å›è¯¥å­—èŠ‚ä¸ºé•¿åº¦ï¼ˆmode=1ï¼ŒANSIï¼‰

è‹¥ == 0xFFï¼šå†è¯» 2 å­—èŠ‚ï¼š

è‹¥ == 0xFFFEï¼š*mode=2ï¼ˆå®½å­—èŠ‚ï¼‰ï¼Œå†è¯» 1 å­—èŠ‚é•¿åº¦ï¼›è‹¥è¯¥å­—èŠ‚ !=0xFF è¿”å›å®ƒï¼Œå¦åˆ™å†è¯» 2 å­—èŠ‚ç»§ç»­

è‹¥ != 0xFFFFï¼šè¿”å›è¯¥ 2 å­—èŠ‚ä¸ºé•¿åº¦

è‹¥ == 0xFFFFï¼šå†è¯» 4 å­—èŠ‚é•¿åº¦ï¼›è‹¥ä¸º -1 è¿˜ä¼šå†è¯»é¢å¤– 4 å­—èŠ‚å¹¶åšå¼‚å¸¸æ£€æŸ¥

0.2.4 CString Read å°è£…å‡½æ•°æ—ï¼ˆsub_10014770 / sub_1001BAA0 / sub_10083D30 ç­‰ï¼‰

ç­‰ä»·é€»è¾‘ï¼š
len = AfxReadStringLength(&mode)ï¼›mode==1 è¯» lenï¼Œå¦åˆ™è¯» len*2 å¹¶è½¬ CString(char)ã€‚
è¯»ä¸æ»¡æŠ› AfxThrowArchiveException(3,0)ã€‚

0.3 CArchive::Read/Write çš„æ ¼å¼å±‚ç»“è®ºï¼ˆå·²ç¡®å®šï¼‰

CArchive::Read/Write ä»…åšç¼“å†²/å¯¹é½/åº•å±‚ I/Oï¼Œä¸ä¼šæ’å…¥éšå¼ marker/padding

Read/Write å‰æ£€æŸ¥è¯»å†™æ¨¡å¼ï¼ˆé”™è¯¯æŠ›å¼‚å¸¸ï¼‰

ç»“è®ºï¼š æ–‡ä»¶æ ¼å¼åªéœ€å…³å¿ƒè°ƒç”¨å±‚å†™äº†ä»€ä¹ˆï¼ˆ<< / >> / WriteObject / WriteCount / Writeï¼‰ï¼Œæ— éœ€æ‹…å¿ƒ CArchive å†…éƒ¨æ”¹å†™å¸ƒå±€ã€‚

1) Normalï¼ˆæ™®é€šå‹ï¼‰CLDBoxï¼ˆsub_10022A10ï¼‰
1.1 å†™å…¥é¡ºåºï¼ˆStoringï¼‰

BaseSerialize(sub_100387B0) åæ— æ¡ä»¶å†™ï¼š

u32 this+356

u32 this+360

u8 this+400

CString this+404

u32 in_count this+292 + in_count * InPin::Serialize()

u32 out_count this+320 + out_count * OutPin::Serialize()

âœ… InPins åç«‹åˆ» out_countï¼Œä¸­é—´æ—  marker/paddingã€‚

1.2 Loading ç‰ˆæœ¬å·®å¼‚

Loadingï¼šSerializeVersion >= 6 æ‰è¯» this+356/360

Storingï¼šæ— æ¡ä»¶å†™

âœ… ç”Ÿæˆå™¨æ°¸è¿œå†™ï¼›è§£æå™¨æŒ‰ç‰ˆæœ¬æ¶ˆè´¹ã€‚

2) Normal CLDInPin / CLDOutPinï¼ˆsub_10048FB0ï¼‰
2.1 å†™å…¥é¡ºåºï¼ˆStoringï¼‰

u8 f0 @ this+548

u8 f1 @ this+549

CString pin_name @ this+544

CString bind_value @ this+552

u32 binding_id @ this+576ï¼ˆå†™ç«¯æ— æ¡ä»¶å†™ï¼‰

2.2 çº å

FF FF FF FF = ä¸Šä¸€æ¡ pin çš„ binding_id=-1

åé¢çš„ 01 00 = ä¸‹ä¸€æ¡ pin çš„ u8+u8

âœ… ä¸å­˜åœ¨â€œå…±äº« record headerâ€ã€‚

2.3 binding_id è¯»å–å·®å¼‚

Loadingï¼šSerializeVersion >= 13 æ‰è¯» this+576

âœ… ç”Ÿæˆå™¨æ°¸è¿œå†™ï¼›è§£æå™¨æŒ‰ç‰ˆæœ¬è¯»ã€‚

3) Normal CLDElement Baseï¼ˆsub_100387B0ï¼‰
3.1 å†™å…¥é¡ºåºï¼ˆStoringï¼‰

u32 ID @ this+4

u8 TypeID @ this+184

CString Name @ this+188

CString Comment @ this+200

CString Desc @ this+204

u32 ConnCount @ this+76

ConnRefs: ConnCount * u32ï¼ˆè§ 3.2ï¼‰

âœ… Base ä¸å«åæ ‡/å°ºå¯¸å­—æ®µã€‚

3.2 ConnRefs çš„çœŸå®è¯­ä¹‰ï¼ˆå·²é’‰æ­»ï¼‰

BaseSerialize å†™ç«¯å¾ªç¯å†™çš„æ˜¯ sub_10037610(connArray, i) çš„è¿”å›å€¼ã€‚

3.2.1 sub_10037610ï¼ˆå†™ç«¯å–å€¼ï¼‰
v2 = this[19];
if (!v2 || i >= v2) return -1;
return *(u32*)(this[18] + 4*i);


this[18] = u32* connRefArray

this[19] = connRefArraySize

è¶Šç•Œ/æ— è¡¨æ—¶è½ç›˜ 0xFFFFFFFF

3.2.2 sub_100375D0ï¼ˆè¯»ç«¯å†™å…¥ï¼‰
if (idx >= this[2]) sub_10037470(idx+1, -1);
*(u32*)(this[1] + 4*idx) = value;


è‡ªåŠ¨æ‰©å®¹å¹¶ç”¨ -1 å¡«å……

å†å†™å…¥ connRefArray[idx] = value

âœ… ç»“è®ºï¼šNormal conn è¡¨å°±æ˜¯ u32 æ•°ç»„ç›´æ¥è½ç›˜ï¼ˆè¶Šç•Œå†™ -1ï¼‰ã€‚

4) Normal CLDNetwork / CLDOr / CLDBracket
4.0 Normal CLDNetworkï¼ˆsub_100501F0ï¼‰

BaseSerialize

è¿½åŠ ï¼šCString this+54 + CString this+55

4.1 Normal CLDOrï¼ˆsub_10051150ï¼‰

Serialize = BaseSerialize only

4.2 Normal CLDBracketï¼ˆsub_1002CFB0ï¼‰

BaseSerialize

u8 bracket_type @ +220

u32 field224 @ +224

subobj1 polymorphic @ +232ï¼ˆvtable+8ï¼‰

u32 count @ +252

count * PinLike::Serialize()ï¼ˆvtable+8ï¼‰

if bracket_type==2: subobj2 polymorphic @ +228

5) Normal CLDContactï¼ˆsub_10034920ï¼‰

BaseSerialize

u8 this+220

CString this+580ï¼ˆoperandï¼‰

5.x Normalï¼švtable Serialize æ§½ä½è§„åˆ™ + TextInfo é“è¯

Serialize = vtable + 8ï¼ˆindex=2ï¼‰

CElementTextInfoï¼š

vtable+4 = deleting dtor

vtable+8 = nullsub â‡’ Serialize ä¸º no-opï¼ˆå†™ 0 å­—èŠ‚ï¼‰

âœ… åæ ‡ç»“è®ºï¼ˆæ”¶å£ï¼‰ï¼šå·²å±•å¼€çš„ Base/Network/Contact/Or/Box/TextInfo å‡ä¸å†™åæ ‡ â‡’ Normal çš„æ ¸å¿ƒå…ƒç´ æ•°æ®ç›®å‰è¡¨ç°ä¸º çº¯æ‹“æ‰‘ ConnRefsï¼ˆåæ ‡åº”åœ¨å…¶ä»–å¯¹è±¡/å…¶ä»–å­å¯¹è±¡ä¸­ï¼›è‹¥å­˜åœ¨ï¼‰ã€‚

6) Safetyï¼ˆå®‰å…¨å‹ï¼‰è§„åˆ™ï¼ˆLDMDLï¼‰
6.1 Safety::CLDElement Base

Storingï¼š

u32 ID

u8 Type

CString Nameï¼ˆä»… 1 ä¸²ï¼‰

u32 ConnCount

ConnIDs: ConnCount * u32

6.2 Safety::CLDNetwork

BaseSerialize(6.1)

CString this[48]

CString this[49]

6.3 Safety::CLDBox

BaseSerialize(6.1)

u8 box_flag

CString instance_name

u32 in_count + InPins

u32 out_count + OutPins

âœ… InPins åç«‹åˆ» out_countï¼Œæ—  paddingã€‚

6.4 Safety::CLDContact

BaseSerialize(6.1)

u8 flag @ this+196

âœ… Safety Contact æ²¡æœ‰ operand CStringã€‚

6.5 Safety::CLDInPin

ä»… 2 ä¸ª CStringï¼š

CString @ this+180

CString @ this+184

âœ… æ—  u8/u16 flagã€æ—  u32 binding_idã€‚

6.6 Safety::CLDOutPin

ä»… 2 ä¸ª CStringï¼š

CString @ this+168

CString @ this+172

6.7 Safety::CLDOr / CLDAssign / CLDJump / CLDReturn

éƒ½æ˜¯ï¼šSerialize = BaseSerialize only

6.8 Safety::CLDOutput

BaseSerialize(6.1)

u8 @ this+196

u8 @ this+204

7) MFC Object Streamï¼šClass headerï¼ˆWriteClass / Store / Load / ReadClassï¼‰

æ³¨ï¼šclass header æ˜¯â€œç±»å±‚â€ï¼ˆWriteClass/ReadClassï¼‰ï¼Œä¸â€œå¯¹è±¡å±‚â€WriteObject/ReadObject æ˜¯ä¸¤å¥— map/id ç©ºé—´ã€‚

7.1 CArchive::WriteClassï¼ˆç¡®å®šï¼‰

å‰ææ£€æŸ¥ï¼š

a2 == NULL â‡’ AfxThrowArchiveException(6, â€¦)

ar.IsLoading â‡’ AfxThrowArchiveException(1, â€¦)

a2->m_wSchema == 0xFFFF â‡’ AfxThrowNotSupportedException()

MapObject() ç¡®ä¿ class-map å­˜åœ¨

7.1.1 å·²å‡ºç°è¿‡è¯¥ CRuntimeClassï¼ˆå†™â€œç±»å¼•ç”¨â€ï¼‰

è®¾ id = map[a2]ï¼ˆé 0 è¡¨ç¤ºå·²ç™»è®°ï¼‰ï¼š

è‹¥ id < 0x7FFFï¼šå†™ u16( id | 0x8000 )

âœ… æœ€é«˜ä½ 0x8000 è¡¨ç¤ºâ€œclass-id å¼•ç”¨â€ï¼Œä½ 15 ä½æ˜¯ id

è‹¥ id >= 0x7FFFï¼š

å†™ u16 0x7FFF

å†™ u32( id | 0x80000000 )

âœ… 0x7FFF ä½œä¸ºæ‰©å±•å“¨å…µï¼›u32 çš„æœ€é«˜ä½ 0x80000000 ä¸ºå¼•ç”¨æ ‡è®°

7.1.2 é¦–æ¬¡å‡ºç°è¯¥ CRuntimeClassï¼ˆå†™â€œç±»å®šä¹‰â€ï¼‰

å†™ u16 0xFFFF

è°ƒ CRuntimeClass::Store(a2, ar) å†™å‡ºç±»ä¿¡æ¯ï¼ˆè§ 7.2ï¼‰

CheckCount(ar) + map[a2] = ar->m_nMapCount; m_nMapCount++

âœ… ä¿®æ­£ï¼šæ ·æœ¬é‡Œ FF FF 00 00 ... åº”ç†è§£ä¸º u16 0xFFFF + ç´§éš Store() çš„å¼€å¤´å­—æ®µï¼ˆschema å¸¸ä¸º 0ï¼‰ï¼Œä¸å†å‡è®¾å­˜åœ¨å›ºå®š u32 0xFFFF0000 markerã€‚

7.2 CRuntimeClass::Store / Loadï¼ˆå·²ç¡®å®šï¼‰
7.2.1 Storeï¼ˆå†™ç±»å®šä¹‰ä½“ï¼‰

å†™å…¥é¡ºåºï¼š

u16 schemaï¼ˆåç¼–è¯‘ï¼š*((u16*)this + 4)ï¼‰

u16 nameLen = lstrlenA(className)

nameLen å­—èŠ‚ ASCII classNameï¼ˆä¸å« \0ï¼‰

7.2.2 Loadï¼ˆè¯»ç±»å®šä¹‰ä½“ï¼‰

è¯»å…¥é¡ºåºï¼š

è¯» u16 schemaï¼Œå›ä¼  *a2 = schema

è¯» u16 nameLen

è‹¥ nameLen >= 0x40ï¼šå¤±è´¥è¿”å› 0

è¯» nameLen å­—èŠ‚åˆ° char name[64]

è‹¥ Read(...) != nameLenï¼šå¤±è´¥è¿”å› 0

name[nameLen] = 0

return CRuntimeClass::FromName(name)

âœ… ç»“è®ºï¼šç±»åæœ€å¤§ 63 å­—èŠ‚ï¼ˆç•™ 1 å­—èŠ‚ç»™ 0 ç»ˆæ­¢ï¼‰ã€‚

7.3 CArchive::ReadClassï¼ˆç¼–ç è¯»æ³•è¦ç‚¹ï¼Œå·²ç¡®å®šï¼‰

è¯»ç«¯æ ¸å¿ƒï¼š

å…ˆè¯»ä¸€ä¸ª 16-bit tagï¼ˆåç¼–è¯‘å˜é‡æ˜¯ void* v18 ä½† _WORD ä½¿ç”¨æ˜ç¡®ä¸º u16 è¯­ä¹‰ï¼‰

è‹¥ tag == 0x7FFFï¼šå†è¯» u32 extï¼Œå¾—åˆ° v5 = ext
å¦åˆ™ï¼šv5 = (tag & 0x7FFF) | ((tag & 0x8000) << 16)ï¼ˆæŠŠ 0x8000 ä½æ‰©å±•åˆ° u32 çš„æ›´é«˜ä½æ®µï¼‰

å…³é”®åˆ†æ”¯ï¼š

v5 < 0ï¼ˆæœ€é«˜ä½ä¸º 1ï¼‰ â‡’ è¿™æ˜¯ â€œclass ç›¸å…³â€ åˆ†æ”¯

tag == 0xFFFF â‡’ æ–°ç±»å®šä¹‰ï¼šCRuntimeClass::Load(...)

å¦åˆ™ â‡’ ç±»å¼•ç”¨ï¼šæŒ‰ index å–å·²æ³¨å†Œ runtime class

v5 >= 0 â‡’ è¿”å› 0ï¼ˆæ— ç±»ï¼‰ï¼Œå¹¶ç”¨ a4 å›ä¼ è¯¥å€¼

å…¸å‹ç”¨äºå¯¹è±¡å±‚çš„ â€œå¼•ç”¨/NULLâ€ åˆ†æ”¯é…åˆï¼ˆè§ 12)

8) æœ€ç»ˆ Rule Map æ±‡æ€»ï¼ˆå¯ç›´æ¥å¤åˆ¶ï¼‰
8.1 CStringï¼ˆé€šç”¨ï¼‰

åŒ 0.2

8.2 Normal::CLDElement Base

u32 ID + u8 Type + CString Name + CString Comment + CString Desc + u32 ConnCount + ConnRefs[u32]*

8.3 Normal::CLDBox

Base + u32 + u32 + u8 + CString + u32 in_count + InPins + u32 out_count + OutPins

8.4 Normal::CLDInPin/OutPin

u8 + u8 + CString + CString + u32(binding_id)

8.5 Normal::CLDNetwork

Base + CString + CString

8.6 Normal::CLDContact

Base + u8 + CString(operand)

8.7 Normalï¼šSerialize æ§½ä½ & TextInfo

vtable+8 = Serializeï¼›CElementTextInfo::Serialize = no-op

8.8 Safety::CLDElement Base

u32 ID + u8 Type + CString Name + u32 ConnCount + ConnIDs[u32]*

8.9 Safety::CLDNetwork

Base(8.8) + CString + CString

8.10 Safety::CLDBox

Base(8.8) + u8 + CString + u32 in_count + InPins + u32 out_count + OutPins

8.11 Safety::CLDContact / CLDOutput / Base-only èŠ‚ç‚¹

Safety::CLDContact = Base + u8

Safety::CLDOutput = Base + u8 + u8

Safety::CLDOr/Assign/Jump/Return = Base only

âœ… 8.12 CIECPOU / CPOUï¼ˆå·²æ•´åˆï¼šå˜ä½“ Bï¼‰
8.12.1 è°ƒç”¨å…³ç³»

CIECPOU::Serialize ä»…è°ƒç”¨ CPOU::Serialize

8.12.2 CPOU::Serializeï¼ˆå˜ä½“ Bï¼‰æ–°å¢â€œå‰å¯¼ u32 æ—¶é—´æˆ³/ç§å­â€

å†™ç«¯å¼€å¤´ï¼šæ— æ¡ä»¶å†™ u32 tï¼ˆæ¥è‡ª _time64() ä½ 32 ä½ï¼Œä¸” t!=0ï¼‰

è¯»ç«¯è¯»å–/è·³è¿‡æ¡ä»¶ï¼š

SerializeVersion >= 0x0Fï¼šè¯»å–è¯¥ u32

< 0x0Fï¼š

è‹¥ ProjectType==1 || CPOU::s_bLibTag || SerializeVersion < 0x0Aï¼šä¸è¯»

å¦åˆ™ï¼šè¯»

8.12.3 CPOU::Serializeï¼ˆå˜ä½“ Bï¼‰ä¸»å­—æ®µå—é¡ºåº

åœ¨å‰å¯¼ u32ï¼ˆè‹¥è¯»ç«¯æ¶ˆè´¹ï¼‰ä¹‹åï¼š

CString this+8

CString this+20

u8 this+24

u8 this+25

u32 this[7]

u32 this[9]

u32 this[10]

u32 this[11]

CString this+52

u8 this+32

u32 this+43

u32 this[12]

CString this+56

è‹¥ SerializeVersion < 0x44ï¼šthis+56 = this+52

å¦åˆ™ï¼šä» archive è¯» CString this+56

8.12.4 CStringArray å—ï¼ˆu32 count + count*CStringï¼‰

Storingï¼šu32 N=this+22ï¼Œå¾ªç¯å†™ N ä¸ª CString

Loadingï¼šè¯» N æ¬¡ CString å¹¶ CStringArray::SetAtGrow(this+80, this+22, str)

8.12.5 DB typed-list å—ï¼ˆu32 n + repeat{u8 TypeID + obj->Serialize}ï¼‰

Storingï¼šå†™ u32 count = *(this+25)+12ï¼Œéå†é›†åˆå†™ u8 TypeID + Serialize

Loadingï¼šè¯» u8 TypeIDï¼Œnew å¯¹åº” DB ç±»ï¼ŒSerializeï¼Œå– name upper åæ’å…¥æ˜ å°„ï¼ˆsub_10036090ï¼‰

8.12.6 ä¸¤æ®µ CMemFile blobï¼ˆProjectType==1 æˆ– s_bLibTagï¼‰

blob1ï¼šu32 size1 + bytes[size1]ï¼ˆthis+31ï¼‰

blob2ï¼šu32 size2 + bytes[size2]ï¼ˆthis+32ï¼‰

8.12.7 å¯†ç /æ ¡éªŒå—ï¼ˆSerializeVersion>=4ï¼‰

è‹¥ <0x3Cï¼šè¯»å–ä¸¤æ¬¡ 16 bytesï¼ˆå…± 32 bytesï¼Œä¸¤æ®µï¼‰

å¦åˆ™ï¼ˆ>=0x3Cï¼‰ï¼š

u8 this+184

16 bytes -> this+192

16 bytes -> this+208

æ ¡éªŒå¤±è´¥ï¼šu8 this+224 = 1

å†™ç«¯å¯¹åº”ï¼šu8 + 16 + 16

8.12.8 æœ«å°¾ä¸¤ä¸ª flagï¼ˆSerializeVersion>=0x29ï¼‰

u8 this+253

u8 this+254

âœ… 8.13 CPOUDetail::Serializeï¼ˆåˆå¹¶å»é‡ç‰ˆï¼‰

ç»“è®ºï¼š çº¯ CString ä¸²æµï¼›ä¸æºå¸¦åæ ‡/RECT/POINT/è·¯å¾„ç‚¹ã€‚è¯»ç«¯æ¬¡æ•°ç”±å¤–éƒ¨åˆå§‹åŒ– this+20 å†³å®šï¼ˆCLDPOU::Serialize ä¸­ç¡®å® Initial è¿‡ï¼‰ã€‚

8.13.1 Loadingï¼ˆar.IsLoadingï¼‰

ç½® this+14 = 1

å¾ªç¯ i=0..this+20-1ï¼š

è¯» CStringï¼ˆsub_10083D30ï¼‰

CStringArray::SetAtGrow(this+60, this+17, str)

ä¸è¯»å– countï¼šæ¬¡æ•°å›ºå®šä¸º this+20

8.13.2 Storingï¼ˆar.IsStoringï¼‰

éå† *(_DWORD**)(this[1]+4) é“¾

å¯¹æ¯ä¸ª itemï¼šè‹¥ item!=0 && *(u8*)(item+20)==1ï¼š

sub_100810A0(ar, item) å†™å‡ºä¸€ä¸ª CStringï¼ˆitem çš„å­—ç¬¦ä¸²å†…å®¹ï¼‰

ä¸å†™ countï¼šè¾“å‡ºæ•°é‡ç”±è¿‡æ»¤æ¡ä»¶å†³å®š

âœ… sub_100810A0 å·²é’‰æ­»å°±æ˜¯ AfxWriteStringLength + Write(bytes) çš„æ ‡å‡† CString å†™æ³•ï¼ˆANSIï¼‰ã€‚

âœ… 8.14 CCrossRecord::Serialize

é¡ºåºå¯¹ç§°ï¼š

CString this+8

u32 this+4

subobject Serialize @ this+12ï¼ˆvtable+8ï¼‰

âœ… 8.15 CLDPOU::Serializeï¼ˆé¡¶å±‚ç»“æ„ï¼Œä¸»é“¾è·¯å·²é’‰æ­»ï¼‰
8.15.1 Storingï¼ˆå†™ï¼‰

CIECPOU::Serializeï¼ˆ= CPOU::Serializeï¼‰

æ„é€ ä¸´æ—¶ CObList tmp

éå†å†…éƒ¨å…ƒç´ é›†åˆï¼ˆsub_1002E430(&state,&v10,&v11)ï¼‰ï¼š

è‹¥ *((u8*)obj + 210) == 0 â‡’ tmp.AddTail(obj)

tmp.Serialize(ar)ï¼ˆè§ 8.16ï¼šObject Streamï¼‰

å†™ CString this+840

å†™ CString this+552

(*(this+135)->Serialize(vtable+8))(this+135, ar)

æ³¨ï¼šè¯¥å¯¹è±¡åœ¨ä½ å½“å‰æ ·æœ¬ä¸º CPOUDetailï¼Œå·²è¯å®æ˜¯å­—ç¬¦ä¸²æµï¼Œä¸æ˜¯å¸ƒå±€è¡¨

8.15.2 Loadingï¼ˆè¯»ï¼‰

CLDPOU::DelElementClear(this,1)

tmp.Serialize(ar)ï¼ˆè§ 8.16ï¼‰

è¯» CString this+840

è¯» CString this+552

this+156 = this+552

éå† v9 é“¾ï¼Œå°†å¯¹è±¡å†™å…¥ç´¢å¼•ï¼š*sub_100348B0(*(obj+4)) = obj

tmp.RemoveAll()

CLDPOU::CalcRelation(this)

CPOUDetail::Initial(this+135, ..., OptionsInfo+480)

(*(this+135)->Serialize(vtable+8))(this+135, ar)

âœ… 8.16 CObList::Serialize = MFC Object Streamï¼ˆCount + WriteObject/ReadObjectï¼‰
8.16.1 Storingï¼ˆå†™ï¼‰

WriteCount(count=this->m_nCount)

éå†é“¾è¡¨èŠ‚ç‚¹ï¼šWriteObject(node->data)

8.16.2 Loadingï¼ˆè¯»ï¼‰

count = ReadCount()

å¾ªç¯ count æ¬¡ï¼š

obj = ReadObject(ar, 0)

AddTail(obj)

âœ… ç»“è®ºï¼šåˆ—è¡¨è½ç›˜æ˜¯ count + count * ObjectStream(Object)ï¼Œå¤šæ€ä¿¡æ¯ç”± WriteObject/ReadObject æä¾›ã€‚

9) DB å­å—è§„åˆ™ï¼ˆå·²é—­ç¯ï¼šTypeID æ˜ å°„ + å„ DB::Serializeï¼‰
âœ… 9.1 TypeID åˆ†æ´¾ï¼šCAppGlobalFunc::GetVarTypeï¼ˆå·²ç¡®å®šï¼‰
if IsKindOf(CFunctionBlockDB) return 24;
if IsKindOf(CStructDB)        return 11;
if IsKindOf(CArrayDB)         return 9;
if IsKindOf(CPointerDB)       return 13;
else                          return 21; // CBaseDB

9.2 typed list é€šç”¨å°è£…

å†™ï¼šu8 TypeID + obj->Serialize

è¯»ï¼šu8 TypeID â†’ new å¯¹åº”ç±» â†’ Serialize

æœªè¯†åˆ« type ä¼šå¼‚å¸¸/ä¸­æ–­åˆ†æ”¯

9.3 CBaseDB::Serializeï¼ˆä¿æŒåŸæ–‡ + ç”¨ 10.3 å®¹å™¨å®ç°è¡¥å¼ºï¼‰

å›ºå®šå­—æ®µåºåˆ—ä¿æŒåŸæ–‡

this+12 åˆ†æ”¯ï¼š

(pathä¸ºç©º æˆ– suffix==".hlf") && SerializeVersion>=0x11ï¼šu32 count + repeat{CString key + CString value}

å¦åˆ™ï¼šå•ä¸€ CString this+12

9.4 CStructDB / CArrayDB / CPointerDB / CFunctionBlockDB

åŸæ–‡ 8.18ï½8.21 ä¿æŒæœ‰æ•ˆï¼ˆä¸æ”¹ï¼Œåªåœ¨ 11 ä¸ 10 è¡¥å¼ºå®ç°ä¾æ®ï¼‰ã€‚

10) è¿è¡Œæ—¶å®¹å™¨/æ•°ç»„çš„çœŸå®å®ç°ï¼ˆç”¨äºåŒæ„å®ç°/å†™ç«¯å¤åˆ»ï¼‰

âœ… ä¿ç•™ä½ åŸæ–‡ç»“æ„ï¼ˆä¸é‡å¤æ‰©å†™ï¼‰ï¼š

âœ… 10.1 CStringArray::SetAtGrow / SetSizeï¼ˆå­—æ®µå¸ƒå±€ã€å¢é•¿ç­–ç•¥ clamp(size/8,4,1024)ã€æ‰©å®¹åˆå§‹åŒ–ã€ç¼©å°æ—¶ææ„ï¼‰

âœ… 10.2 PairArray8 çš„ SetSizeï¼ˆ8å­—èŠ‚å…ƒç´ ã€memset 0ã€æ‰©å®¹é€»è¾‘åŒå‹ï¼‰

âœ… 10.3 KV å“ˆå¸Œå®¹å™¨ï¼ˆHashKeyï¼šFNV1a å˜ä½“ + æ­¥é•¿é‡‡æ · len/10+1ï¼›Node16ï¼škey/value CString + next + hashï¼›æ’å…¥/åˆ é™¤/æ¸…ç©ºä¸ freelist/CPlex å·²ç¡®å®šï¼‰

11) DB è§„åˆ™è¡¥ä¸ï¼ˆä¸å®¹å™¨å®ç°å¯¹é½ï¼‰
11.1 BaseDB this+12 çš„â€œè¯­è¨€æ˜ å°„å—â€

è¿­ä»£é¡ºåºä¸ bucket/é“¾ç›¸å…³ï¼ˆéæ’åºï¼‰

éœ€å­—èŠ‚çº§å¤åˆ»ï¼šå¤åˆ» HashKey ä¸æ’å…¥é¡ºåº

11.2 CArrayDB pair è¡¨

pairCount + repeat(u32,u32) æ­£ç¡®

å†…éƒ¨å°±æ˜¯ 10.2 çš„ PairArray8

âœ… 12) MFC Object Streamï¼ˆCArchive::WriteObject / ReadObjectï¼‰ï¼ˆé—­ç¯ç‰ˆï¼‰
12.1 WriteObjectï¼ˆStoringï¼‰è§„åˆ™ï¼ˆå·²ç¡®å®šï¼‰

ä»…åœ¨ ar.IsStoring åˆæ³•ï¼Œå¦åˆ™æŠ›å¼‚å¸¸

MapObject(ar,0) ç¡®ä¿æ˜ å°„å­˜åœ¨

ä¸‰ç§æƒ…å†µï¼š

12.1.1 NULL

å†™ u16 0

12.1.2 å·²å‡ºç°å¯¹è±¡ï¼ˆå†™å¼•ç”¨ IDï¼‰

id = map[obj]

è‹¥ id < 0x7FFFï¼šå†™ u16 id

è‹¥ id >= 0x7FFFï¼šå†™ u16 0x7FFF + u32 id

12.1.3 é¦–æ¬¡å‡ºç°å¯¹è±¡ï¼ˆå†™ç±»å¤´ + å†…å®¹ï¼‰

WriteClass(obj->GetRuntimeClass())

é¦–æ¬¡ç±»ï¼šu16 0xFFFF + Store(schema+nameLen+nameBytes)

é‡å¤ç±»ï¼šå†™ç±»å¼•ç”¨ç¼–ç ï¼ˆè§ 7ï¼‰

CheckCount

è®°å½• object-idï¼šmap[obj] = m_nMapCount; m_nMapCount++

obj->Serialize(ar)

âœ… å¯¹è±¡å±‚ï¼ˆWriteObjectï¼‰ä¸ç±»å±‚ï¼ˆWriteClassï¼‰å„è‡ªæœ‰ç‹¬ç«‹ map/id ç©ºé—´ã€‚

12.2 ReadObjectï¼ˆLoadingï¼‰è§„åˆ™ï¼ˆå·²ç¡®å®šï¼‰

ä»…åœ¨ ar.IsLoading åˆæ³•ï¼Œå¦åˆ™æŠ›å¼‚å¸¸

ReadClass(ar, expectedClass, &schema, &idOrTag) å†³å®šåˆ†æ”¯

12.2.1 æ–°å¯¹è±¡ï¼ˆruntimeClass != NULLï¼‰

obj = runtimeClass->CreateObject()ï¼›å¤±è´¥æŠ›å¼‚å¸¸

CheckCount(ar)

å°† obj æ’å…¥ loadArrayï¼ˆIDâ†’objï¼‰

æ ¹æ®åŠ è½½çŠ¶æ€è¡¨å¤„ç† schema/çŠ¶æ€ï¼ˆåç¼–è¯‘ä½“ç°ä¸ºçŠ¶æ€æ•°ç»„å†™å…¥ + ä¿å­˜/æ¢å¤ this[4]ï¼‰

obj->Serialize(ar)

è¿”å› obj

12.2.2 å¼•ç”¨å·²æœ‰å¯¹è±¡ï¼ˆruntimeClass == NULLï¼‰

å– refId = idOrTag

æ£€æŸ¥ refId åˆæ³•ï¼›çŠ¶æ€ä¸å…è®¸ï¼ˆå¦‚ â€œæ­£åœ¨åŠ è½½â€ï¼‰åˆ™æŠ›å¼‚å¸¸

obj = loadArray[refId]

è‹¥ caller ç»™äº† expectedClass ä¸” !obj->IsKindOf(expectedClass)ï¼šæŠ›ç±»å‹ä¸åŒ¹é…å¼‚å¸¸

è¿”å› obj

12.3 ReadCount / WriteCountï¼ˆå·²ç¡®å®šï¼‰

WriteCount(count)ï¼š

count < 0xFFFFï¼šå†™ u16 count

å¦åˆ™ï¼šå†™ u16 0xFFFF å†å†™ u32 count

ReadCount()ï¼š

å…ˆè¯» u16 tmpï¼Œè‹¥ tmp != 0xFFFF è¿”å› tmpï¼›å¦åˆ™å†è¯» u32

12.4 ç”± 8.15/8.16 æ¨å¯¼çš„â€œä¸»è§£æè·¯å¾„â€ç»“è®ºï¼ˆå·²ç¡®å®šï¼‰

Normal POU å†…å…ƒç´ /é™„å±å¯¹è±¡ä¸»è·¯å¾„ï¼š

ReadCount â†’ ReadObject â†’ obj->Serialize

CLDPOU::Factory(type) ä»å­˜åœ¨ï¼Œä½†ä¸æ˜¯è¿™æ¡è½ç›˜é“¾è·¯çš„é©±åŠ¨ï¼ˆæ›´å¯èƒ½ç”¨äºå¯¼å…¥/æ„é€ /éå¯¹è±¡æµåœºæ™¯ï¼‰ã€‚

âœ… 13) åæ ‡/å¸ƒå±€ï¼ˆå½“å‰æ”¶å£ç»“è®ºï¼‰

å·²å±•å¼€çš„å¤šæ•°æ ¸å¿ƒå…ƒç´  Serialize ä¸å« x/y/w/h/ç‚¹é›†

CLDPOU::Serialize åœ¨å¯¹è±¡æµååªå‰©ï¼š

CString this+840

CString this+552

this+135 å­å¯¹è±¡ Serialize

ä½† this+135 å½“å‰æ ·æœ¬ä¸º CPOUDetailï¼Œå·²ç¡®å®šä¸ºå­—ç¬¦ä¸²æµï¼ˆå˜é‡/æ–‡æœ¬ç±»ä¿¡æ¯ï¼‰ï¼Œä¸æºå¸¦åæ ‡/RECT/POINT

å› æ­¤ è‹¥ Normal å­˜åœ¨å¸ƒå±€/åæ ‡ï¼Œç›®å‰å”¯ä¸€åˆç†è½ç‚¹æ˜¯ï¼š

Object Stream åˆ—è¡¨é‡Œå°šæœªè¯†åˆ«/å°šæœªåç¼–è¯‘çš„å…¶ä»–å¯¹è±¡ç±»ï¼ˆä¾‹å¦‚ layout/view/route/annotation ç±»ï¼‰
ï¼ˆå³ï¼šåæ ‡ä¸æ˜¯â€œå…ƒç´ æœ¬ä½“å­—æ®µâ€ï¼Œè€Œæ˜¯â€œé¢å¤–å¯¹è±¡ç±»â€ï¼‰

âœ…ï¼ˆé™„ï¼‰æœ¬è½®æ–°å¢æ¡ç›®å·²è½ç›˜ä½ç½®ç´¢å¼•

CRuntimeClass::Store/Loadï¼šå·²å¹¶å…¥ 7.2

CArchive::ReadClass ç¼–ç ç»†èŠ‚ï¼šå·²å¹¶å…¥ 7.3

ReadCount/WriteCountï¼šå·²å¹¶å…¥ 12.3

sub_100810A0ï¼ˆCPOUDetail item = CString å†™ï¼‰ï¼šå·²å¹¶å…¥ 8.13ï¼ˆå¹¶ç”¨äºç¡®è®¤ï¼‰

â€œFF FF 00 00â€ marker çº æ­£ï¼šå·²å¹¶å…¥ 7.1ï¼ˆåˆ é™¤æ—§æ¨æµ‹ markerï¼‰


A) CBaseDB å†™ç«¯ï¼ˆStoring, ar.IsStoringï¼‰

ä»ä½ çš„åç¼–è¯‘æ¥çœ‹ï¼Œå†™ç«¯è°ƒç”¨ä¸€ä¸² sub_10010320(ar, addr)ï¼ˆå¯è§†ä½œâ€œå†™ CStringâ€æˆ–â€œå†™æŸå­—æ®µï¼ˆå¤šæ•°æ˜¯ CStringï¼‰â€çš„å°è£…ï¼‰ï¼Œå¹¶å¤¹æ‚è‹¥å¹²åŸå§‹æ•´æ•°/å­—èŠ‚å†™å…¥ã€‚

å†™å…¥é¡ºåºï¼ˆç¡®å®šï¼‰ï¼š

sub_10010320(ar, this+4)

sub_10010320(ar, this+8)

sub_10010320(ar, this+12)ï¼ˆä½†æ³¨æ„ï¼šå†™ç«¯å…ˆå¯¹ this+12 åšäº† GetStringTOResourceID çš„æ˜ å°„å¤„ç†åå†å†™ï¼‰

sub_10010320(ar, this+16)

å†™ u8 this+20

sub_10010320(ar, this+32)

å†™ u8 this+48

å†™ u32 this[13]ï¼ˆä¹Ÿå°±æ˜¯ *(u32*)(this+52)ï¼‰

å†™ u32 this[14]ï¼ˆä¹Ÿå°±æ˜¯ *(u32*)(this+56)ï¼‰

sub_10010320(ar, this+60)

å†™ u8 this+64

å†™ u16 this+66ï¼ˆ*((WORD*)this+33)ï¼‰

å†™ u8 this+69ï¼ˆå†™ç«¯åšäº† !=0 å½’ä¸€æˆ 0/1ï¼‰

å†™ u32 this[19]ï¼ˆ*(u32*)(this+76)ï¼‰

å†™ u8 this+80

å†™ u8 this+81ï¼ˆå†™ç«¯åŒæ · !=0 å½’ä¸€ï¼‰

âœ… è¿™ä¸€æ®µéå¸¸å…³é”®ï¼šå®ƒå‘Šè¯‰ä½  BaseDB æœ¬ä½“å°±å·²ç»æºå¸¦äº†ä¸å°‘â€œæ ‡å¿—ä½/æ•°å€¼å­—æ®µâ€ï¼Œè€Œä¸æ˜¯çº¯å­—ç¬¦ä¸²ã€‚

B) CBaseDB è¯»ç«¯ï¼ˆLoadingï¼‰â€”â€”æŒ‰ SerializeVersion çš„å†å²å…¼å®¹è·¯å¾„

ä½ è´´å‡ºæ¥çš„ç»“æ„éå¸¸æ¸…æ™°ï¼šå¤§ä½“æ˜¯ SerVer < 0x34 ä¸€ç»„æ—§æ ¼å¼ï¼Œ>=0x34 ä¸€ç»„æ–°æ ¼å¼ã€‚

B.1 SerializeVersion >= 0x34

ä¾æ¬¡è¯»å–ï¼ˆé€šè¿‡ sub_10011B50 / sub_10014880 / sub_1000FE90 / sub_10012FC0 / sub_1000FF30 / sub_10030230 / sub_10010BC0 è¿™äº›å°è£…ï¼‰ï¼š

è¯» this+4

è¯» this+8

è¯» this+12

è¯» this+16

è¯» this+20

è¯» this+32

è¯» this+48

è¯» this+52

è¯» this+56

è¯» this+60

è¯» this+64

è¯» this+66

è¯» this+69

âœ… é¢å¤–ï¼šsub_10012FC0(ar, this+76)ï¼ˆåªåœ¨ >=0x34 åˆ†æ”¯é‡Œå‡ºç°ï¼‰

B.2 SerializeVersion < 0x34

åˆåˆ† 3 æ®µè€ç‰ˆæœ¬ï¼š

0x1B <= ver < 0x34ï¼šè¯»åˆ° this+69 åï¼Œè¿˜ä¼šé¢å¤– sub_10010BC0(ar, this+69)ï¼ˆçœ‹èµ·æ¥æ˜¯æ–°åŠ çš„ bool/flag çš„å…¼å®¹è¯»ï¼‰

0x19 <= ver < 0x1Bï¼šå­—æ®µé‡Œå‡ºç° this+52 çš„è¯»å–ï¼ˆsub_10012FC0(ar, this+52)ï¼‰

ver < 0x19ï¼šä¼šä» archive è¯»ä¸€ä¸ª u16 a2ï¼Œæœ€å this[13] = (u16)a2ï¼ˆä¹Ÿå°±æ˜¯æŠŠæ—§æ ¼å¼çš„æŸä¸ªçŸ­å­—æ®µæ˜ å°„åˆ° this+52ï¼‰

âœ… ç»“è®ºï¼šè¯»ç«¯éœ€è¦ä¸¥æ ¼æŒ‰ç‰ˆæœ¬èµ°ï¼Œä¸ç„¶ä¼šåœ¨ this+52/56/69/76 ç­‰å­—æ®µä¸Šé”™ä½ã€‚

C) CBaseDB è¯»å®Œåçš„ç»Ÿä¸€åå¤„ç†ï¼ˆéå¸¸é‡è¦ï¼‰

æ— è®ºèµ°å“ªä¸ªè¯»åˆ†æ”¯ï¼Œæœ€åéƒ½ä¼šæ‰§è¡Œï¼š

vtable+100(this, 0)

if (SerVer < 0x34): å¦‚æœå…¨å±€ ProjectID / SolidProjectID æœ‰æ•ˆï¼Œä¼šæŠŠ this[19]ï¼ˆä¹Ÿå°±æ˜¯ this+76ï¼‰æ”¹å†™æˆå…¨å±€ IDï¼ˆè¿™æ˜¯è¿è¡ŒæœŸ patchï¼Œä¸æ¥è‡ªæ–‡ä»¶ï¼‰

if (SerVer >= 0x38) è¯»å– this+80

if (SerVer >= 0x44) è¯»å– this+81

âœ… è¿™è¯´æ˜ï¼š

this+80 æ˜¯ 0x38 æ–°å¢å­—æ®µ

this+81 æ˜¯ 0x44 æ–°å¢å­—æ®µ
ä¸”å®ƒä»¬åœ¨å†™ç«¯æ˜¯æ— æ¡ä»¶å†™çš„ï¼ˆä½ å†™ç«¯ç¡®å®å†™äº† 80/81ï¼‰ï¼Œç¬¦åˆä½ â€œç”Ÿæˆå™¨æ°¸è¿œå†™ï¼Œè§£æå™¨æŒ‰ç‰ˆæœ¬è¯»â€çš„æ€»ç­–ç•¥ã€‚

âœ… 9.x.2 CStructDB::Serializeï¼ˆç»“æ„ä½“ï¼šmember typed-listï¼‰

ä½ è´´çš„ CStructDB å¾ˆå¹²å‡€ï¼š

å¼€å¤´ CBaseDB::Serialize(this, ar)

å†™ç«¯ï¼ˆStoringï¼‰ï¼š

å†™ u32 this[25]ï¼ˆæˆå‘˜æ•°ï¼‰

éå† this[23] çš„é“¾è¡¨ï¼šå¯¹æ¯ä¸ª memberï¼ˆCBaseDB*ï¼‰ï¼š

å†™ u8 VarType = GetVarType(member)

member->Serialize(ar)

è¯»ç«¯ï¼ˆLoadingï¼‰ï¼š

è¯» u32 count

å¾ªç¯ count æ¬¡ï¼š

è‹¥ SerVer < 0x2Dï¼šç›´æ¥ new CBaseDB(0x58)ï¼ˆä¸å¸¦ type byteï¼‰

å¦åˆ™ï¼šè¯» u8 typeï¼Œswitchï¼š

8 â†’ CStringDB(0x7C)

9 â†’ CArrayDB(0xA4)

11 â†’ CStructDB(0x74)

13 â†’ CPointerDB(0x60)

24 â†’ CFunctionBlockDB(0x118)

default â†’ CBaseDB(0x58)

obj->Serialize(ar)

sub_10020070(obj)ï¼ˆçœ‹èµ·æ¥æ˜¯â€œåŠ å…¥ DB ç´¢å¼•/æ³¨å†Œ/å»é‡â€çš„ç»Ÿä¸€å…¥å£ï¼‰

âœ… è¿™å—ç›´æ¥æŠŠ â€œtyped-list çš„è¯»å†™èŒƒå¼â€é’‰æˆï¼š
u32 count + repeat{ u8 type + obj }ï¼ˆä½ç‰ˆæœ¬ä¾‹å¤–ï¼‰

âœ… 9.x.3 CPointerDB::Serializeï¼ˆæŒ‡é’ˆï¼šä¸¤ä¸ªå­—ç¬¦ä¸² + ç‰ˆæœ¬å›å¡«ï¼‰

å…ˆ CBaseDB::Serialize

å†™ç«¯ï¼ˆStoringï¼‰ï¼š

å†™ this+88

å†™ this+92

è¯»ç«¯ï¼ˆLoadingï¼‰ï¼š

è¯» this+88

è‹¥ SerVer < 0x44ï¼šthis+92 = this+88

å¦åˆ™ï¼ˆ>=0x44ï¼‰ï¼šå†è¯» this+92ï¼›å¦‚æœ this+92 ä¸ºç©ºåˆ™å›å¡«ä¸º this+88

âœ… ç»“è®ºï¼šCPointerDB åœ¨ 0x44 ç‰ˆæœ¬å¼€å§‹çœŸæ­£è½ç›˜ç¬¬äºŒä¸ªå­—ç¬¦ä¸²å­—æ®µï¼›æ—§ç‰ˆæœ¬ç”¨å›å¡«ç»´æŒè¡Œä¸ºä¸€è‡´ã€‚

âœ… 9.x.4 CArrayDB::Serializeï¼ˆæ•°ç»„ï¼šç»´åº¦ pair è¡¨ + typed-list + æ—§ç‰ˆå…¼å®¹å­—ç¬¦ä¸²æ˜ å°„ï¼‰

ä½ çš„ CArrayDB å¾ˆé•¿ï¼Œä½†å…³é”®ç»“æ„å·²ç»éå¸¸æ¸…æ¥šäº†ã€‚æˆ‘æŒ‰â€œè½ç›˜å—â€æ¥æŠ½ï¼š

A) å¤´éƒ¨ï¼šç»§æ‰¿ CBaseDB::Serialize
B) ç»´åº¦/Pair è¡¨å—ï¼ˆä½ ä¹‹å‰ 10.2/11.2 é‚£å¥—è¢«åå®äº†ï¼‰

å†™ç«¯ï¼šå…ˆå†™ä¸€ä¸ª u32 this[22]ï¼ˆçœ‹èµ·æ¥æ˜¯ pairCount / dimCountï¼‰

ç„¶åç´§è·Ÿ å†å†™ä¸€æ¬¡ u32 this[22]ï¼ˆä»ä½ ä»£ç çœ‹ç¡®å®æœ‰ä¸¤æ¬¡å†™åŒå€¼çš„è¡Œä¸ºï¼šä¸€æ¬¡é€šè¿‡ sub_10010320/ä¸€æ¬¡ç›´æ¥ raw å†™ï¼›ä½ å®ç°æ—¶è¦æŒ‰å­—èŠ‚å¤åˆ»ï¼Œä¸è¦â€œä¼˜åŒ–æ‰â€ï¼‰

ç„¶åå¾ªç¯å†™ pairï¼šæ¯ä¸ªç»´åº¦å†™ä¸¤ä¸ª u32ï¼ˆä» this[24] + 2*v å’Œ +1 å–å€¼ï¼‰

è¯»ç«¯åŒç†ï¼š

å…ˆè¯» this[22]

å†è¯» u32 v75ï¼ˆpairCountï¼‰

å¾ªç¯ v75 æ¬¡ï¼šè¯» u32 a, u32 bï¼Œè°ƒç”¨ sub_1008EEB0(this[25], a, b)ï¼ˆå³åŠ å…¥ pair è¡¨ï¼‰

âœ… è¿™å—å°±æ˜¯ä½ ä¹‹å‰ Rule Map é‡Œâ€œpairCount + repeat(u32,u32)â€çš„é“è¯å‡çº§ç‰ˆï¼š
ç°åœ¨è¿â€œè¯»ç«¯æ’å…¥å‡½æ•°â€éƒ½å¯¹ä¸Šäº†ã€‚

C) æ—§ç‰ˆï¼ˆSerVer < 0x44ï¼‰ç»´åº¦åˆ°å­—ç¬¦ä¸²çš„å…¼å®¹æ˜ å°„

è¯»ç«¯é‡Œå‡ºç°äº†ä¸¤ç§è·¯å¾„ï¼š

SerVer < 0x44ï¼šå®ƒä¼šç”¨ Format("%d", pair[i].a/b) ç”Ÿæˆä¸¤ä¸ª CStringï¼Œå†é€šè¿‡ sub_1008F260(this[30], ...) æ’å…¥ï¼ˆçœ‹èµ·æ¥æ˜¯ KV/æ˜ å°„å®¹å™¨ï¼‰

SerVer >= 0x44ï¼šç›´æ¥ä» archive è¯»ä¸¤æ®µ CStringï¼ˆkey/valueï¼‰ï¼Œå†æ’å…¥ sub_1008F260

âœ… è¿™è¯´æ˜ï¼š

0x44 ä¹‹å‰ï¼šæ–‡ä»¶é‡Œå¯èƒ½ ä¸å­˜ key/value å­—ç¬¦ä¸²ï¼Œè€Œæ˜¯è¿è¡ŒæœŸç”¨æ•°å­— pair æ ¼å¼åŒ–ç”Ÿæˆ

0x44 å¼€å§‹ï¼šæ–‡ä»¶é‡Œç›´æ¥å­˜ key/value CString å¯¹

D) typed-list å­å¯¹è±¡å—

åœ¨ç»´åº¦å—ä¹‹åï¼Œä½ èƒ½çœ‹åˆ°ï¼š

è¯» u32 v76ï¼ˆcountï¼‰

å¾ªç¯ count æ¬¡ï¼š

SerVer < 0x2Dï¼šnew CBaseDB

å¦åˆ™ï¼šè¯» u8 typeï¼Œswitch 8/9/11/13/24/21ï¼Œnew å¯¹åº”ç±»ï¼ŒSerialize

sub_10020070(obj)

å†™ç«¯å¯¹åº”ï¼š

å†™ u32 this[36]ï¼ˆcountï¼‰

éå† this[34] é“¾è¡¨ï¼šå†™ u8 type + Serialize

âœ… ç»“è®ºï¼šCArrayDB å†…éƒ¨ä¹ŸåµŒå¥—äº†ä¸€æ®µ typed-listï¼ˆå’Œ StructDB çš„ member list åŒæ„ï¼‰ã€‚

âœ… 9.x.5 CFunctionBlockDB::Serializeï¼ˆFBï¼šå¤šæ®µ typed-list + æœ«å°¾ KV æ˜ å°„ï¼‰

ä½ è´´å‡ºæ¥çš„æ˜¯ä¸€ä¸ªå·¨å‹å‡½æ•°ï¼Œä½†ç»“æ„éå¸¸æ˜æ˜¾ï¼šå®ƒä¸æ˜¯â€œä¸€ä¸ª typed-listâ€ï¼Œè€Œæ˜¯â€œå¤šæ®µ typed-listï¼ˆè‡³å°‘ 5 æ®µä»¥ä¸Šï¼‰+ æœ€åä¸€æ®µ key/value æ˜ å°„è¡¨â€ã€‚

A) å†™ç«¯ï¼ˆStoringï¼‰â€”â€”å¤šæ®µ list

åœ¨ä½ è´´çš„ååŠæ®µï¼ˆStoring åˆ†æ”¯ï¼‰èƒ½çœ‹åˆ°é‡å¤çš„æ¨¡å¼ï¼š

å†™ u32 countX

éå†æŸä¸ªé“¾è¡¨ this + æŸä¸ªindexï¼š

å†™ u8 type

obj->Serialize

è¿™ä¸ªæ¨¡å¼é‡å¤å‡ºç°ï¼Œåˆ†åˆ«ç”±è¿™äº›å­—æ®µé©±åŠ¨ï¼ˆæˆ‘ç”¨ä½ åç¼–è¯‘ä¸­å‡ºç°çš„ä¸‹æ ‡æ ‡è®°ï¼‰ï¼š

u32 this[25] + list this[23]

u32 this[32] + list this[30]

u32 this[39] + list this[37]

u32 this[46] + list this[44]

u32 this[53] + list this[51]

æœ€åè¿˜æœ‰ä¸€æ®µï¼š

å†™ u32 this[66]

å¾ªç¯ j=0..this[66)-1ï¼š

å–ä¸€ä¸ª CStringï¼ˆæ¥è‡ª this[65] + 4*j è¿™ç§æ•°ç»„è®¿é—®ï¼‰

å†™è¯¥ CString

å†æ„é€ å¦ä¸€ä¸ª CStringï¼ˆsub_10031520(...) ä¹‹ç±»ä» key æ´¾ç”Ÿ valueï¼‰

å†å†™è¿™ä¸ªæ´¾ç”Ÿ CString

âœ… è¿™æ„å‘³ç€ï¼šFB DB æœ¬ä½“é‡ŒåŒ…å«å¤šç»„â€œå†…éƒ¨æˆå‘˜/æ¥å£/å˜é‡åŒºå—â€ï¼Œæ¯ç»„éƒ½æ˜¯ typed-listã€‚ä½ ç°åœ¨è‡³å°‘èƒ½ç¡®å®šâ€œæœ‰ 5 ç»„ typed-list + 1 ç»„ KV è¡¨â€ã€‚

B) è¯»ç«¯ï¼ˆLoadingï¼‰

è¯»ç«¯å¯¹åº”çš„ç»“æ„ä¹Ÿéå¸¸æ¸…æ¥šï¼š

å…ˆè¯» count1 + typed-list1

å†è¯» count2 + typed-list2

å†è¯» count3 + typed-list3

å†è¯» count4 + typed-list4

å†è¯» count5 + typed-list5

æœ€åè¯» u32 v135ï¼ˆkvCountï¼‰

å¾ªç¯ kvCount æ¬¡ï¼šè¯» CString key + CString value

CStringArray::SetAtGrow(...) ä¿å­˜ key

å¹¶æŠŠ value å†™å…¥ä¸€ä¸ªæ˜ å°„ï¼ˆsub_10031630(key) æ‰¾æ§½ï¼Œç„¶å operator=(slot, value)ï¼‰

âœ… æœ€ç»ˆç»“è®ºï¼šCFunctionBlockDB çš„å˜é‡/æ¥å£ä¿¡æ¯è¿œæ¯” BaseDB/StructDB æ›´å¤æ‚ï¼Œå®ƒæœ¬èº«å°±æ˜¯â€œå¤š sectionâ€ã€‚


Rule Map æ›´æ–°ï¼ˆå˜é‡ DB å®Œæ•´é—­ç¯å¢é‡ï¼‰
0.2 CString è¯»å†™å°è£…å‡½æ•°æ—ï¼ˆæ­£å¼å®šå‹ï¼šå­—èŠ‚çº§ï¼‰
0.2.5 å†™ CStringï¼šsub_10010320(ar, cstr_addr)ï¼ˆå·²ç¡®å®šï¼‰

ç­‰ä»·äºï¼š

len = CString.length

AfxWriteStringLength(ar, len, isUnicode=0)

ar.Write(chars, len)ï¼ˆä¸å« \0ï¼‰

âœ… ç»“è®ºï¼šå®ƒå°±æ˜¯ANSI CString çš„æ ‡å‡†å†™æ³•ã€‚

0.2.6 è¯» CStringï¼šsub_10011B50(ar, cstr_addr)ï¼ˆå·²ç¡®å®šï¼‰

ç­‰ä»·äºï¼š

len = AfxReadStringLength(ar, &mode)

è‹¥ mode==1ï¼šè¯» len å­—èŠ‚ â†’ CString(ANSI)

å¦åˆ™ï¼šè¯» len*2 å­—èŠ‚ â†’ CString(å®½å­—èŠ‚è¾“å…¥ï¼Œä½†æœ€ç»ˆä»å­˜åˆ° CStringT<char>ï¼ŒMFC ä¼šåšè½¬æ¢/æˆªæ–­é€»è¾‘)

è¯»ä¸æ»¡ï¼šAfxThrowArchiveException(3,0)ã€‚

âœ… è¿™ä¹Ÿç›´æ¥è¯æ˜ä½  0.2.4 çš„æ€»ç»“å®Œå…¨æ­£ç¡®ï¼Œå¹¶ä¸”mode çš„åˆ¤å®šå°±æ˜¯ AfxReadStringLength è¾“å‡ºçš„ v10ã€‚

0.x å­—èŠ‚å­—æ®µè¯»å°è£…ï¼ˆå…¨éƒ¨é’‰æ­»ï¼‰

è¿™äº›å°è£…ç°åœ¨ä¸ç”¨çŒœäº†ï¼š

sub_10014880(ar, u8*)ï¼šè¯» u8

sub_1000FE90(ar, u8*)ï¼šè¯» u8ï¼ˆå’Œä¸Šé¢ç­‰ä»·ï¼Œå¯èƒ½æ˜¯ä¸åŒè¯­ä¹‰çš„åŒ…è£…åï¼‰

sub_10012FC0(ar, u32*)ï¼šè¯» u32

sub_1000FF30(ar, u32*)ï¼šè¯» u32ï¼ˆåŒå‹ï¼‰

sub_10030230(ar, u16*)ï¼šè¯» u16

sub_10010BC0(ar, bool*)ï¼šè¯» u8ï¼Œå¹¶å½’ä¸€ä¸º bool = byte!=0

âœ… è¿™æ„å‘³ç€ï¼šä½ ä¹‹å‰åœ¨ CBaseDB::Serialize é‡Œå¯¹ â€œè¿™äº›å‡½æ•°è¯»çš„æ˜¯å•¥â€ çš„å¼ºæ¨æ–­ï¼Œç°åœ¨å…¨éƒ¨å‡çº§ä¸ºç¡®å®šäº‹å®ã€‚

âœ… 9.x DBï¼šæ–°å¢ CStringDB + BaseDB çš„ stringâ†’resourceID æ˜ å°„
9.x.6 CStringDB::Serializeï¼ˆæ–°å¢ï¼Œå·²é—­ç¯ï¼‰
Storingï¼ˆå†™ï¼‰

ç»§æ‰¿ï¼šCBaseDB::Serialize

ç„¶åï¼š

u32 count = this[27]

this[22] = count

å†™ u32 count

å†™ CString this+92ï¼ˆsub_10010320ï¼‰

éå† this[25] é“¾è¡¨ï¼šå¯¹æ¯ä¸ªèŠ‚ç‚¹ v7ï¼Œè°ƒç”¨ v7->Serialize(ar)ï¼ˆvtable+8ï¼‰

âœ… ä¹Ÿå°±æ˜¯è¯´ï¼šCStringDB è½ç›˜ç»“æ„æ˜¯ï¼š

CBaseDB

u32 count

CString extra92

count * (CBaseDB-like object serialized via vtable+8)ï¼ˆæ³¨æ„ï¼šå†™ç«¯å¹¶ä¸å†™ type byteï¼Œè¿™æ„å‘³ç€è¿™äº›å­é¡¹çš„å…·ä½“ç±»åº”å½“ç”±å„è‡ª Serialize è‡ªæè¿°æˆ–å›ºå®šä¸º BaseDBï¼›è¯»ç«¯ä¹Ÿç¡®å®æ˜¯å›ºå®š new BaseDBï¼‰

Loadingï¼ˆè¯»ï¼‰

ç»§æ‰¿ï¼šCBaseDB::Serialize

ç„¶åï¼š

è¯» u32 this[22]

è‹¥ SerializeVersion < 0x44ï¼š

this+92 = Format("%d", this[22])
å¦åˆ™ï¼š

è¯» CString this+92ï¼ˆsub_10011B50ï¼‰

å¾ªç¯ this[22] æ¬¡ï¼š

new CBaseDB(0x58)

obj->Serialize(ar)ï¼ˆvtable+8ï¼‰

sub_10020070(obj)ï¼ˆæ³¨å†Œ/å…¥åº“ï¼‰

âœ… ç»“è®ºï¼šCStringDB çš„å­é¡¹åœ¨è¯»ç«¯å¼ºåˆ¶å½“æˆ CBaseDBï¼ˆæ—  typed-list çš„ type byteï¼‰ï¼Œè¿™å¾ˆå…³é”®ï¼šå®ƒå’Œ StructDB/ArrayDB/FBDB çš„ typed-list æœºåˆ¶ä¸åŒã€‚

9.x.7 CAppGlobalFunc::GetStringTOResourceID(outCString, inCString)ï¼ˆæ–°å¢ï¼Œå†³å®š BaseDB çš„ this+12 å†™ç«¯è¡Œä¸ºï¼‰

è¿™æ˜¯ä½ é—®çš„â€œæ˜¯å¦éœ€è¦ generator å¤åˆ»æ˜ å°„â€çš„å…³é”®ç‚¹ã€‚

å‡½æ•°é€»è¾‘ï¼ˆå»å™ªåçš„çœŸå®è¯­ä¹‰ï¼‰ï¼š

å¦‚æœ byte_10263AEE == 0 æˆ– inCString ä¸ºç©ºï¼š

out = in

å¦åˆ™ï¼š

æ„é€ ä¸€ä¸ª Default å­—ç¬¦ä¸²ï¼ˆv8ï¼‰

å– inCString çš„ char*ï¼Œè°ƒç”¨ sub_10031520(in, ...) åšä¸€æ¬¡æŸ¥è¡¨/è½¬æ¢åˆ¤æ–­ï¼š

è‹¥æˆåŠŸï¼šout = Defaultï¼ˆæ³¨æ„ï¼šä»åç¼–è¯‘çœ‹æˆåŠŸåˆ†æ”¯é€‰äº† &v8ï¼‰

è‹¥å¤±è´¥ï¼šè®°å½•æ—¥å¿—ï¼ˆsub_10020BA0(..., unk_101BE294, in) + WriteLogï¼‰ï¼Œout = in

âœ… è¿™æ„å‘³ç€ï¼šBaseDB å†™ç«¯å¯¹ this+12ï¼š

ä¸€èˆ¬æƒ…å†µï¼šå†™åŸå§‹ this+12

ä½†åœ¨ byte_10263AEE å¼€å¯ä¸” this+12 éç©ºæ—¶ï¼šå¯èƒ½ä¼šè¢«æ›¿æ¢ä¸ºä¸€ä¸ªâ€œDefaultâ€ï¼ˆèµ„æºåŒ–æ ‡è®°/å ä½å­—ç¬¦ä¸²ï¼‰ï¼Œå¹¶ä¸”ä»…åœ¨ sub_10031520 å‘½ä¸­æ—¶å‘ç”Ÿã€‚

å¯¹ generator çš„ç›´æ¥ç»“è®ºï¼š

å¦‚æœä½ ç”Ÿæˆçš„æ–‡ä»¶æ˜¯ä¸ºäº†â€œè¢«åŒä¸€å¥—è¿è¡Œæ—¶è¯»â€ï¼Œæœ€ç¨³å¦¥æ˜¯ï¼šå…ˆæŒ‰ä½ å·²æœ‰ç­–ç•¥å†™åŸå§‹ this+12ï¼›

é™¤éä½ ä¹Ÿè¦åœ¨ Rust ç«¯å¤åˆ» byte_10263AEE çš„è¿è¡Œæ—¶è¯­ä¹‰/èµ„æºè¡¨ï¼Œå¦åˆ™ä¸è¦å¼ºè¡Œå†™ Defaultã€‚

æ¢å¥è¯è¯´ï¼šGetStringTOResourceID æ˜¯ç¯å¢ƒä¾èµ–ï¼ˆå…¨å±€ flag + å¤–éƒ¨è¡¨ï¼‰ï¼Œä¸æ˜¯çº¯æ–‡ä»¶æ ¼å¼çº¦æŸã€‚

âœ… 9.x.1 CBaseDB::Serializeï¼šä½ ä¹‹å‰çš„è§„åˆ™é‡Œâ€œå°è£…å«ä¹‰â€ç°åœ¨å…¨éƒ¨å®šå‹

ä½ ä¹‹å‰ BaseDB çš„è¯»å†™é¡ºåºå·²ç»å¯¹äº†ï¼›æœ¬æ¬¡æ–°å¢è®©å®ƒâ€œå­—èŠ‚çº§å¯å®ç°â€ï¼š

sub_10011B50 = read CString

sub_10014880 = read u8

sub_10012FC0 / sub_1000FF30 = read u32

sub_10030230 = read u16

sub_10010BC0 = read bool (u8!=0)

å› æ­¤ä½ åœ¨ Rule Map é‡Œå¯¹ BaseDB çš„å­—æ®µå—å¯ä»¥ç›´æ¥å†™æˆï¼š

BaseDBï¼ˆå†™ç«¯å›ºå®šï¼‰ï¼š
CString(this+4), CString(this+8), CString(mapped this+12), CString(this+16), u8(this+20), CString(this+32), u8(this+48), u32(this+52), u32(this+56), CString(this+60), u8(this+64), u16(this+66), bool(this+69), u32(this+76), u8(this+80), bool(this+81)

è¯»ç«¯ï¼šæŒ‰ç‰ˆæœ¬æ¶ˆè´¹ï¼ˆä½ åŸæ¥é‚£æ®µä¿æŒæœ‰æ•ˆï¼‰ã€‚



âœ… 11.x Stringâ†’ResourceID æ˜ å°„è¡¨ï¼ˆæœ€ç»ˆå®šå‹ï¼‰

11.x.1 å¼€å…³

byte_10263AEE æ§åˆ¶æ˜¯å¦å¯ç”¨æ˜ å°„é€»è¾‘

11.x.2 æ˜ å°„è¡¨æ„å»ºï¼šCAppGlobalFunc::FillStringTOResourceID

è¯»å– <å·¥ç¨‹è·¯å¾„>\Resourceid.ini

section: STRINGTOID

StringNum å†³å®šæ¡ç›®æ•°ï¼ˆé»˜è®¤ 2ï¼‰

æ¯æ¡ï¼š

key = StringSTR{i}

value = StringID{i}

æ’å…¥ï¼šmap[key] = value

map å®ä¾‹ï¼šdword_10263CC0

11.x.3 æŸ¥è¯¢ï¼šsub_10031520 / sub_10031290

hash = HashKey(key)

bucket = hash % bucketCount

éå†é“¾è¡¨ï¼š

node.hash == hash ä¸” CString::Compare(node.key, key)==0 â‡’ å‘½ä¸­ï¼Œè¿”å› node.value

11.x.4 Node ç»“æ„ï¼ˆ16 bytesï¼‰

+0 CString key

+4 CString value

+8 Node* next

+12 u32 hash


ä½ ç°åœ¨å¯ä»¥ç›´æ¥å†™çš„ Safety å˜é‡è¡¨è§£æä¼ªç»“æ„ï¼ˆæœ€ç»ˆç‰ˆï¼‰

å¯¹æ¯ä¸ª VarListï¼ˆ4 æ®µä¹‹ä¸€ï¼‰ï¼š

u32 total_count;
repeat total_count times:
  u8 vartype;     // 9/11/13/24/21(å¸¸è§)ï¼›å…¶å®ƒå€¼æŒ‰ CBaseDB å®¹é”™
  VarObjectBody   // ç”± SerializeForOpenOfVar -> obj->Serialize è¯»


å…¶ä¸­ CBaseDB çš„ bodyï¼ˆä½ å·²ç»å®Œæ•´æ‹¿åˆ°ï¼‰ï¼š

CString name;        // +4
CString comment;     // +8
CString datatype_or_i18n; // +12 (hlf + ver>=0x11 èµ°ç¿»è¯‘æ˜ å°„é€»è¾‘ï¼Œå¦åˆ™ç›´æ¥å­—ç¬¦ä¸²)
CString datatype;    // +44 (BOOL/INT/...)
u8 init_flag;        // +48
CString init_value;  // +52
u8 retain_flag;      // +76
u16 var_id;          // +78
u32 addr_id;         // +80
CString extra;       // +84
u8 mode_flags;       // +88 (è¯»å®Œä¼š &~8)
u16 seq_id;          // +90
if ver>=0x18: u8 b93;
if ver>=0x24: u8 b108;






1) CLDElementï¼ˆäºŒè¿›åˆ¶å¸ƒå±€ï¼‰æœ€ç»ˆæ ¼å¼
å†™å…¥åˆ†æ”¯ï¼ˆar.IsStoring()ï¼‰

æŒ‰é¡ºåºå†™ï¼š

ElementIDï¼šu32

v4 = *((_DWORD*)this + 47);
WriteU32(v4);


âœ… this + 47*4 = this+188

Flags/TypeByteï¼šu8ï¼ˆåªæœ‰ 1 å­—èŠ‚ï¼‰

v34 = *((_BYTE*)this + 176);
WriteU8(v34);


âœ… this+176ï¼ˆä½ ä¹‹å‰è¯´â€œBase: 1 String + ConnIDs + No Coordsâ€å®Œå…¨å»åˆï¼‰

ä¸€ä¸ªå­—ç¬¦ä¸²ï¼ˆMFC CStringï¼šAfxWriteStringLength + bytesï¼‰

AfxWriteStringLength(... len of *((_DWORD*)this+45)-12 ...);
Write(bytes at *((void**)this+45), len);


âœ… this + 45*4 = this+180 è¿™ä¸ª CStringï¼ˆæˆ– ATL CStringï¼‰å¯¹è±¡çš„ç¼“å†²æŒ‡é’ˆè¢«å½“æˆ this[45]

ConnCountï¼šu32

v7 = *((_DWORD*)this + 18);
WriteU32(v7);


âœ… this+72

ConnIDsï¼šConnCount * u32

conn = *(_DWORD *)(*((_DWORD *)this + 17) + 4*i);
WriteU32(conn);


âœ… ConnIDs æ•°ç»„æŒ‡é’ˆåœ¨ this+68ï¼ˆthis+17*4ï¼‰

ç»“è®ºï¼š
CLDElement = [u32 element_id] [u8 flags] [CString name] [u32 conn_count] [u32 conn_id â€¦]
æ²¡æœ‰åæ ‡ã€æ²¡æœ‰ child listã€æ²¡æœ‰ network indexã€‚

è¯»å–åˆ†æ”¯ï¼ˆar.IsLoading()ï¼‰

ä¸¥æ ¼å¯¹ç§°ï¼š

è¯» u32 element_id -> this+188

è¯» u8 flags -> this+176

sub_100152F0(ar, this+180) -> è¯» CString åˆ° this+180

è¯» u32 conn_count

å¾ªç¯ conn_count æ¬¡è¯» u32 conn_idï¼Œappend åˆ° this+68 æ•°ç»„ï¼ˆsub_100029E0 åšæ‰©å®¹å¹¶ç”¨ -1 åˆå§‹åŒ–ï¼‰

2) è¿™æ„å‘³ç€ï¼šNetwork çš„â€œå½’å±å…³ç³»â€ç¡®å®è¦é  Conn å›¾é‡å»ºï¼ˆä½†ç°åœ¨æ›´ç¨³äº†ï¼‰

å› ä¸ºï¼š

CLDNetwork::Serialize = CLDElement::Serialize + Label CString + Comment CString

æ‰€ä»¥ Network æœ‰ element_id / flags / name / connIDs â€”â€”å®ƒåœ¨å›¾é‡Œæ˜¯ä¸ªèŠ‚ç‚¹ã€‚

ä½ ä¹‹å‰æ‹…å¿ƒâ€œNetwork ä¸å‚ä¸è¿çº¿æ‰€ä»¥ BFS ä¼šå¤±æ•ˆâ€ï¼Œç°åœ¨å¯ä»¥å¤§å¹…ç¼“è§£ï¼š
Network è‡³å°‘å…·å¤‡å‚ä¸è¿çº¿çš„èƒ½åŠ›ï¼ˆæ˜¯å¦çœŸçš„è¿åˆ°å…ƒç´ ï¼Œè¦çœ‹æ•°æ®ï¼Œä½†æ ¼å¼ä¸Šå®ƒå°±æ˜¯å›¾èŠ‚ç‚¹ï¼‰ã€‚

3) Safety ç‰ˆ Network å½’å±é‡å»ºï¼šæ¨èâ€œä»¥ Network ä¸ºæºçš„è¿é€šåŸŸæ ‡è®°â€
3.1 è§£æé˜¶æ®µï¼ˆå¿…é¡»åšæˆä¸¤éï¼‰

å…ˆæŠŠ POU é‡Œçš„æ‰€æœ‰ elementï¼ˆä¹±åº hash dumpï¼‰è¯»å‡ºæ¥ï¼Œæ”¾åˆ°ï¼š

HashMap<u32, Element>ï¼ˆkey = element_idï¼‰

åŒæ—¶ä¸ºæ¯ä¸ª element å»ºé‚»æ¥ï¼š

å¯¹æ¯ä¸ª conn_idï¼Œå¦‚æœ conn_id != 0xFFFFFFFF ä¸”å­˜åœ¨äº mapï¼š

adj[element_id].push(conn_id)
-ï¼ˆå»ºè®®ä¹Ÿå»ºåå‘è¾¹ rev_adj[conn_id].push(element_id)ï¼Œåé¢å¾ˆå¥½ç”¨ï¼‰

æ³¨æ„ï¼šä»£ç é‡Œæ²¡æœ‰å†™ -1ï¼Œä½†è¯»æ•°ç»„åˆå§‹åŒ–ç”¨ -1ï¼Œå¾ˆå¯èƒ½æ–‡ä»¶é‡Œä¹Ÿä¼šå‡ºç° 0xFFFFFFFF ä½œä¸ºâ€œç©ºè¿æ¥â€ã€‚

3.2 è¯†åˆ«å“ªäº›èŠ‚ç‚¹æ˜¯ Network

ä½ ç°åœ¨æœ‰ä¸¤æ¡è·¯ï¼ˆè¶Šç¨³è¶Šå¥½ï¼‰ï¼š

è·¯ Aï¼ˆæœ€å¼ºï¼‰ï¼šå¦‚æœå¤–å±‚åºåˆ—åŒ–é‡Œæœ‰â€œå…ƒç´ ç±»å‹æšä¸¾â€ï¼ˆä½ ä¹‹å‰æåˆ° TypeID / ElementTypeï¼‰ï¼Œå°±ç›´æ¥ç”¨å®ƒåˆ¤æ–­ is_networkã€‚

è·¯ Bï¼ˆå¼±ä½†å¯ç”¨ï¼‰ï¼šç”¨ flags/typeByteï¼ˆthis+176ï¼‰çš„å–å€¼åˆ†å¸ƒåšåˆ¤åˆ«ï¼ˆéœ€è¦ä½ ç”¨çœŸå®æ ·æœ¬ç»Ÿè®¡ä¸€ä¸‹å“ªäº›å€¼å¯¹åº” Networkï¼‰ã€‚

å› ä¸ºä½ å·²ç»è´´å‡º CLDNetwork::Serializeï¼Œè¯´æ˜ Network æ˜¯ç‹¬ç«‹ç±»ï¼Œæ–‡ä»¶é‡Œä¸€å®šèƒ½è¯†åˆ«åˆ°å®ƒçš„â€œå¯¹è±¡ç±»å‹â€ï¼ˆåªæ˜¯ä½ è¿˜æ²¡æŠŠé‚£ä¸ªå¯¹è±¡ç±»å‹åˆ†å‘å¤„è´´å‡ºæ¥è€Œå·²ï¼‰ã€‚

3.3 åˆ†é…å½’å±ï¼ˆBFS/DFSï¼‰

å¯¹æ¯ä¸ª Network èŠ‚ç‚¹ Nï¼š

ä» N åœ¨å›¾ä¸Šåš BFSï¼ˆå»ºè®®æ— å‘ï¼šadj + rev_adjï¼‰ï¼Œæ‹¿åˆ°ä¸€ä¸ªå¯è¾¾é›†åˆ S

å°† S é‡Œçš„å…ƒç´ æ ‡è®° network_id = N

å†²çªå¤„ç†ï¼ˆä¸€ä¸ªå…ƒç´ è¢«å¤šä¸ª Network å¯è¾¾ï¼‰

ç°å®é‡Œå¯èƒ½å‘ç”Ÿï¼ˆæ¯”å¦‚å…±äº«æ¯çº¿/ç”µæºè½¨ï¼‰ï¼š

ä¼˜å…ˆè§„åˆ™å»ºè®®ï¼š

å¦‚æœå…ƒç´ æœ¬èº«ç±»å‹æ˜¯ Networkï¼Œä¿ç•™è‡ªèº«

å¦åˆ™é€‰æ‹©â€œæœ€å…ˆå‡ºç°çš„ Networkâ€ï¼ˆæ–‡ä»¶é¡ºåº/ID æœ€å°ï¼‰æˆ–â€œè·ç¦»æœ€è¿‘çš„ Networkâ€ï¼ˆBFS distance æœ€å°ï¼‰

æ›´ PLC è¯­ä¹‰çš„åšæ³•ï¼šä»¥â€œPowerRail / Busâ€ä½œä¸ºè¾¹ç•Œï¼Œé‡åˆ°æŸäº›ç±»å‹èŠ‚ç‚¹å°±åœæ­¢æ‰©æ•£ï¼ˆè¿™è¦é ä½ æŒæ¡ element type æ˜ å°„ååŠ è§„åˆ™ï¼‰ã€‚

3.4 æ—  Network å¯è¾¾çš„å…ƒç´ 

å½’ä¸ºï¼š

Orphanï¼ˆå•ç‹¬ä¸€ç»„ï¼‰

æˆ–è€…â€œé»˜è®¤ç½‘ç»œ 0â€


æŒ‰ CLDPOU::Factory çš„ switchï¼š

Dec	Hex	Class	new size
0	0x00	CLDElement	0xC0
1	0x01	CLDOr	0xF4
2	0x02	CLDAnd	0xE4
3	0x03	CLDBox	0x18C
4	0x04	CLDContact	0x110
5	0x05	CLDOutput	0x114
6	0x06	CLDReturn	0xF4
7	0x07	CLDJump	0x108
8	0x08	CLDAssign	0xD0
9	0x09	CLDNetwork	0x124

ä½ æ ‡æ³¨çš„â€œNormal ç‰ˆ Network=10, Contact=5ï¼›Safety åç§»â€è¿™ä¸ªç°è±¡ä¹Ÿéå¸¸ç¬¦åˆâ€œåŒåç±»åœ¨ä¸åŒ variant é‡Œ ID ä¸ä¸€è‡´â€çš„å¸¸è§åšæ³•ï¼šåˆ«è·¨ variant å¤ç”¨ ID è¯­ä¹‰ï¼Œå¿…é¡»æŒ‰ Factory è¡¨æ¥ã€‚

3) æ›´æ–°åçš„ CLDElement åŸºç±»åºåˆ—åŒ–æ ¼å¼ï¼ˆSafetyï¼‰

æŠŠå­—æ®µåæ”¹æ­£åï¼ŒSafety çš„ CLDElement åŸºç±»å°±æ˜¯ï¼š

[u32 ElementID]                 // this+0xBC (188) = dword[47]
[u8  ElementType]               // fileé‡Œ1å­—èŠ‚ï¼›å†…å­˜è½åœ¨ this+0xB0 çš„ dword ä½å­—èŠ‚
[CString NameOrText @ this+180] // sub_100152F0
[u32 ConnCount]
[u32 ConnIDs...]


CLDNetwork::Serialize = CLDElement::Serialize + ä¸¤ä¸ª CStringï¼ˆLabel/Commentï¼‰ã€‚

4) æ‹“æ‰‘é‡æ„ï¼ˆSafetyï¼‰ç°åœ¨å¯ä»¥â€œä»¥ Network ä¸º rootâ€æ›´ç¨³

å› ä¸º Network æœ¬èº«å°±æ˜¯å›¾èŠ‚ç‚¹ï¼ˆç»§æ‰¿ CLDElementï¼Œå¸¦ ConnIDsï¼‰ï¼Œæ‰€ä»¥ä½ å®Œå…¨å¯ä»¥æŒ‰ç±»å‹è¡¨åˆ¶å®šè§„åˆ™ï¼š

Rootsï¼šType==0x09 (CLDNetwork)

ä¸­ç»§èŠ‚ç‚¹ï¼ˆä¸é˜»æ–­ BFSï¼‰ï¼š0x01 Or, 0x02 And, 0x08 Assignï¼ˆä»¥åŠå¤§å¤šæ•°æ™®é€šèŠ‚ç‚¹ï¼‰

ç»ˆæ­¢/å¶å­å€¾å‘ï¼š0x05 Output, 0x06 Return, 0x07 Jumpï¼ˆä½†æ˜¯å¦é˜»æ–­å–å†³äºä½ å¸Œæœ›â€œç½‘ç»œå½’å±â€åˆ°å“ªä¸€æ­¥ï¼‰

Box ç‰¹ä¾‹ï¼ˆ0x03ï¼‰ï¼šGemini è¯´å¾—å¯¹ï¼šè¿æ¥å¾ˆå¯èƒ½æŒ‚åœ¨ pin ä¸Šï¼ˆä¹Ÿå°±æ˜¯ CLDBox è‡ªå·±çš„æ´¾ç”Ÿå­—æ®µé‡Œè¿˜æœ‰é¢å¤– ConnIDs/PinConnIDsï¼‰ã€‚
ğŸ‘‰ å®ç°æ—¶å»ºè®®ï¼šæ„å›¾æ—¶åˆ«åªç”¨ CLDElement çš„ ConnIDsï¼›è¦æŠŠæ´¾ç”Ÿç±»ï¼ˆå°¤å…¶ Boxï¼‰çš„â€œPinConnIDsâ€ä¹Ÿå¹¶å…¥å›¾ï¼Œå¦åˆ™ä¼šå‡ºç°â€œBox æ–­è·¯â€ã€‚

5) Rust å®ç°å»ºè®®ï¼ˆç›´æ¥å¯è½åœ°ï¼‰

å…ˆç»Ÿä¸€è¯»å‡ºä¸€ä¸ªâ€œåŸå§‹å…ƒç´ å¤´â€ï¼š

element_id: u32

type_id: u8

name: String

conns: Vec<u32>

ç„¶åæŒ‰ type_id èµ°å·¥å‚æ„é€ ä¸åŒ structï¼Œå†ç»§ç»­è§£ææ´¾ç”Ÿå­—æ®µï¼ˆNetwork è¯» label/commentï¼›Box è¯» pinsï¼›Contact/Output è¯»å®ƒä»¬çš„å­—æ®µâ€¦â€¦ï¼‰

æ‹“æ‰‘å½’å±ï¼š

å»º id -> element map

å»ºé‚»æ¥ï¼ˆbase conns + derived connsï¼‰

å¯¹æ¯ä¸ª Network åš BFS/DFSï¼Œæ ‡è®° reachable é›†åˆå½’å±

å†²çªç­–ç•¥ï¼šè·ç¦»æœ€å° / network id æœ€å° / æ–‡ä»¶é¡ºåºæœ€å…ˆï¼ˆä»»é€‰ä¸€ç§å›ºå®šè§„åˆ™ï¼‰

1) CLDContact / CLDOutput / CLDAssignï¼ˆSafetyï¼‰
CLDContact::Serialize

å…ˆ CLDElement::Serialize

ç„¶åé¢å¤– 1 byteï¼š

u8 @ this + 196 (0xC4)

ä¹Ÿå°±æ˜¯æ–‡ä»¶å¸ƒå±€ï¼š

CLDElementBase
u8 contact_flag

CLDOutput::Serialize

å…ˆ CLDElement::Serialize

ç„¶åé¢å¤– 2 byteï¼š

u8 @ this + 196 (0xC4)

u8 @ this + 204 (0xCC)

æ–‡ä»¶å¸ƒå±€ï¼š

CLDElementBase
u8 out_flag1
u8 out_flag2

CLDAssign::Serialize

åªæœ‰ CLDElement::Serialize

æ— é¢å¤–å­—æ®µ

âœ… è¿™ä¸‰ç±»å¯¹æ‹“æ‰‘ï¼ˆConnIDsï¼‰æ²¡æœ‰æ–°å¢æ¥æºï¼šè¿æ¥ä»ç„¶åªæ¥è‡ª CLDElement åŸºç±»ã€‚

2) CLDBox::Serializeï¼ˆSafetyï¼‰â€” è¿™æ˜¯é‡ç‚¹ï¼šPin åˆ—è¡¨åµŒå¥—å†™å…¥
2.1 å†™å…¥é¡ºåºï¼ˆStoreï¼Œ((_BYTE)a2[6] & 1)==0ï¼‰

å…ˆå†™åŸºç±»ï¼š

CLDElement::Serialize(...)


ç„¶åå†™ Box è‡ªå·±çš„å­—æ®µï¼š

u8 box_flag

*((_BYTE*)this + 356)

å³ offset 356 = 0x164 = dword[89] çš„ä½å­—èŠ‚

CString box_text

*((_DWORD*)this + 90) æŒ‡å‘çš„ CString æ•°æ®

ç­‰ä»·äºï¼šBox å†…éƒ¨æœ‰ä¸€ä¸ª CString æˆå‘˜ï¼ˆå¤§æ¦‚ç‡å°±åœ¨ this+360 é™„è¿‘ï¼‰

u32 in_pin_count

*((_DWORD*)this + 63)

CLDInPin[in_pin_count]ï¼ˆé€ä¸ªè°ƒç”¨è™šå‡½æ•° Serializeï¼‰

ä» *((_DWORD*)this + 61) è¿™æ¡é“¾è¡¨ä¸Šå–ç¬¬ i ä¸ªèŠ‚ç‚¹ï¼Œå– node->obj = node[2]ï¼Œå¯¹å®ƒ vtable+8 Serialize

u32 out_pin_count

*((_DWORD*)this + 70)

CLDOutPin[out_pin_count]ï¼ˆåŒç†é“¾è¡¨ï¼‰

é“¾è¡¨å¤´ *((_DWORD*)this + 68)ï¼Œå¯¹è±¡åœ¨ node[2]

æ‰€ä»¥ Box çš„æ–‡ä»¶å¸ƒå±€å°±æ˜¯ï¼š

CLDElementBase
u8      box_flag
CString box_text
u32     in_count
InPin   in_pins[in_count]   // each = InPin::Serialize
u32     out_count
OutPin  out_pins[out_count] // each = OutPin::Serialize

2.2 è¯»å–é¡ºåºï¼ˆLoadï¼Œ((_BYTE)a2[6] & 1)!=0ï¼‰

å®Œå…¨å¯¹ç§°ï¼š

è¯» u8 â†’ å­˜åˆ° *((_DWORD*)this + 89)ï¼ˆä½å­—èŠ‚æœ‰æ•ˆï¼‰

sub_100152F0(a2, (int)this + 360) â†’ è¯» CString åˆ° this+360

è¯» u32 v43 â†’ in_pin_count

å¾ªç¯ v43 æ¬¡ï¼šnew CLDInPin(0xD0) â†’ Serialize â†’ æŒ‚åˆ° Box çš„ in-pin listï¼ˆå†…éƒ¨ç”¨ CPlex åšèŠ‚ç‚¹æ± ï¼‰

å†è¯» u32 v44 â†’ out_pin_count

å¾ªç¯ v44 æ¬¡ï¼šnew CLDOutPin(0xC0) â†’ Serialize â†’ æŒ‚åˆ° out-pin list

âœ… sub_100152F0((int)this+360) è¿™ä¸€åˆ€éå¸¸å…³é”®ï¼šå®ƒæ˜ç¡®å‘Šè¯‰ä½  Box çš„ CString å­—æ®µä½ç½®å°±æ˜¯ this+360ï¼Œè€Œä¸Šé¢ *((_DWORD*)this+90)ï¼ˆ= offset 360ï¼‰æ­£å¥½å»åˆã€‚

3) è¿™æ„å‘³ç€ï¼šBox çš„â€œè¿æ¥å…³ç³»â€æ¥æº = Pinï¼ˆå¾ˆå¯èƒ½ï¼‰ + BoxåŸºç±»ï¼ˆå¯èƒ½æ²¡ç”¨æˆ–åªæ ‡è¯†è‡ªèº«ï¼‰

ä½ ä¹‹å‰çš„ç°è±¡â€œå…ƒç´ ä¸¢å¤±/ç½‘ç»œå½’å±é è¿é€šæ€§é‡å»ºâ€ï¼Œåˆ°äº† Box è¿™é‡Œå¿…é¡»å‡çº§æˆï¼š

Box ä¸æ˜¯ä¸€ä¸ªâ€œå•ç‚¹èŠ‚ç‚¹â€ï¼Œè€Œæ˜¯ä¸€ä¸ªâ€œå†…éƒ¨å«å¤šä¸ª Pin å­èŠ‚ç‚¹çš„å®¹å™¨â€

è¿æ¥è¾¹å¤§æ¦‚ç‡æŒ‚åœ¨ CLDInPin / CLDOutPin çš„ Serialize é‡Œï¼ˆå› ä¸º Box è‡ªå·±é™¤äº† flag/text/count ä¹‹å¤–æ²¡åˆ«çš„äº†ï¼‰

æ‰€ä»¥ä½ çš„é‡å»º/å»ºå›¾è¦è¿™æ ·åšæ‰ç¨³ï¼š

è§£æåˆ° CLDBoxï¼š

å…ˆåˆ›å»ºä¸€ä¸ª box elementï¼ˆè®°å½•å®ƒçš„ element_id/type/name/connidsï¼‰

è§£æ pinsï¼š

æ¯ä¸ª pin è°ƒ Serializeï¼ˆä½ è¿˜æ²¡è´´ pin çš„ä»£ç ï¼Œä½†ä»è®¾è®¡ä¸Šçœ‹ï¼Œå®ƒä»¬å‡ ä¹ä¸€å®šæœ‰è‡ªå·±çš„ ConnIDs æˆ–å¼•ç”¨ç«¯ç‚¹ä¿¡æ¯ï¼‰

å»ºå›¾æ—¶æŠŠ pin ä¹Ÿå½“æˆèŠ‚ç‚¹/ç«¯ç‚¹ï¼š

æŠŠ pin çš„ ConnIDs åŠ å…¥é‚»æ¥

å†ç”¨ä¸€æ¡â€œå½’å±è¾¹â€æŠŠ pin ç»‘å®šå› boxï¼ˆä»…ç”¨äºè¾“å‡ºç»“æ„åŒ–ç»“æœï¼Œä¸ç”¨äºç”µæ°”è¿é€šï¼‰

å¦‚æœä½ åªç”¨ Box åŸºç±» ConnIDs æ¥å»ºå›¾ï¼Œå¾ˆå®¹æ˜“å‡ºç° â€œBox æ–­è·¯â€ã€‚

4) Rust è§£æå™¨å¯ä»¥ç›´æ¥æŒ‰è¿™ä¸ªç»“æ„å†™ï¼ˆæ— éœ€çŒœï¼‰

å»ºè®®æ•°æ®æ¨¡å‹ï¼ˆç¤ºæ„ï¼‰ï¼š

Element { id:u32, type_id:u8, name:String, conns:Vec<u32>, extra: ElementExtra }

ElementExtra::Box { flag:u8, text:String, in_pins:Vec<Pin>, out_pins:Vec<Pin> }

Pin { ... , conns:Vec<u32>, ... } // å…·ä½“å­—æ®µç­‰ä½ è´´ InPin/OutPin çš„ Serialize

è§£æé¡ºåºï¼š

read_element_base()

match type_idï¼š

0x03 â†’ read_box_extra()ï¼ˆæŒ‰ä¸Šé¢é¡ºåºè¯»ï¼‰

0x04 â†’ read_u8

0x05 â†’ read_u8, read_u8

0x08 â†’ nothing

0x09 â†’ read_label, read_commentï¼ˆä½ å·²ç»ç¡®è®¤ï¼‰

å…¶å®ƒ â†’ æŒ‰å„è‡ª Serialize


1) CLDInPin::Serializeï¼ˆSafety æ ¼å¼ï¼‰

ä»…åºåˆ—åŒ–ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œé¡ºåºå›ºå®šï¼š

Storeï¼ˆå†™ï¼‰
CString pin_name_or_left   // this+180
CString pin_desc_or_right  // this+184

Loadï¼ˆè¯»ï¼‰

sub_100152F0(a2, this+180)

sub_100152F0(a2, this+184)

ä½ ä»åç¼–è¯‘é‡Œèƒ½çœ‹å‡ºæˆå‘˜ä½ç½®ï¼š

this + 180 (0xB4) : CString #1

this + 184 (0xB8) : CString #2

å¹¶ä¸”å†™ç«¯ç”¨çš„æ˜¯ *((_DWORD*)this+45)ã€+46ï¼Œ45*4=180ï¼Œå»åˆã€‚

2) CLDOutPin::Serializeï¼ˆSafety æ ¼å¼ï¼‰

åŒæ ·åªæœ‰ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼š

Storeï¼ˆå†™ï¼‰
CString pin_name_or_left   // this+168
CString pin_desc_or_right  // this+172

Loadï¼ˆè¯»ï¼‰

sub_100152F0(a2, this+168)

sub_100152F0(a2, this+172)

æˆå‘˜ä½ç½®ï¼š

this + 168 (0xA8) : CString #1

this + 172 (0xAC) : CString #2

3) å¯¹ CLDBox çš„æœ€ç»ˆç»“è®ºï¼ˆSafetyï¼‰

ç»¼åˆ CLDBox::Serialize + Pin Serializeï¼š

Safety CLDBox æ–‡ä»¶å¸ƒå±€ï¼ˆæœ€ç»ˆç‰ˆï¼‰
CLDElementBase                        // è´Ÿè´£ element_id/type_id/ConnIDs/NameStr ç­‰
u8      box_flag                      // this+356
CString box_text                      // this+360

u32     in_count
repeat in_count:
    CString in_pin_str0               // InPin+180
    CString in_pin_str1               // InPin+184

u32     out_count
repeat out_count:
    CString out_pin_str0              // OutPin+168
    CString out_pin_str1              // OutPin+172


âœ… Pin ä¸å«è¿æ¥ã€ä¹Ÿä¸å« IDã€‚
âœ… Box çš„è¿é€šæ€§ä»ç„¶å¿…é¡»ä» CLDElementBase.ConnIDs[] æ¢å¤ã€‚
âœ… Pin åªç”¨äºæè¿° Box çš„æ¥å£æ ‡ç­¾ï¼ˆä¾‹å¦‚å‚æ•°å/å˜é‡å/æ˜¾ç¤ºå/æ³¨é‡Šç­‰ï¼‰ã€‚

4) Rust è§£æå®ç°è¦ç‚¹ï¼ˆä½ ç°åœ¨å¯ä»¥ç›´æ¥å†™äº†ï¼‰
æ•°æ®ç»“æ„å»ºè®®
struct Pin2Str { s0: String, s1: String }

enum ElementExtra {
  Box { flag: u8, text: String, in_pins: Vec<Pin2Str>, out_pins: Vec<Pin2Str> },
  Contact { b0: u8 },
  Output  { b0: u8, b1: u8 },
  Assign,
  Network { label: String, comment: String },
  // ...
}

è¯»å– Boxï¼ˆSafetyï¼‰

read_cld_element_base()

flag = read_u8()

text = read_cstring()

in_count = read_u32()

loop in_count:

s0=read_cstring(); s1=read_cstring()

out_count = read_u32()

loop out_count:

s0=read_cstring(); s1=read_cstring()

æ‹“æ‰‘é‡å»ºï¼ˆSafetyï¼‰

å¿½ç•¥ Pinï¼ˆPin ä¸è¿›å›¾ï¼‰

å›¾èŠ‚ç‚¹ = æ‰€æœ‰ CLDElement æ´¾ç”Ÿå¯¹è±¡ï¼ˆNetwork/Or/And/Contact/Output/Box/Jump/Return/Assign/â€¦ï¼‰

è¾¹ = CLDElementBase é‡Œé‚£ç»„ u32 conn_ids[]ï¼ˆä½ å·²ç»é€†å‡ºæ¥ï¼šå†™ç«¯æ˜¯ count + æ¯é¡¹ u32ï¼›è¯»ç«¯ä¹Ÿæ˜¯è¯» count å¹¶ pushï¼‰