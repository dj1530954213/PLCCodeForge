# 通讯采集 UI/UX 与表格交互设计规范 v1（设备化 + Excel 级操作）

> 目的：在 100~300 点位的现场典型规模下，让操作人员以接近 Excel 的方式高效完成通讯采集配置与点位绑定，且在实时运行时可快速调整并观察结果。
> 范围：Tauri 桌面应用内的通讯采集模块（连接配置 + 点位表格 + 运行 + 导出）。
> 依据：HMI 全局唯一、设备化、一设备一通道、地址 4xxxx 语义、强校验、运行期可编辑、导出按设备分工作簿。

**版本**：v1.0
**状态**：Draft（可执行）
**更新时间**：2026-01-06
**适用范围**：PLCCodeForge / 通讯采集模块

---

## 目录

- 0. 背景与目标
- 1. 术语与对象
- 2. 设计原则与硬约束
- 3. 信息架构与页面布局
- 4. 设备模型与持久化
- 5. 视觉与排版规范（UI 风格）
- 6. 表格区域布局与列定义
- 7. 编辑与交互细节
- 8. Excel 级粘贴与批量操作
- 9. 地址输入语义与推断规则
- 10. 校验规则与阻断逻辑
- 11. 错误提示与闪烁规范
- 12. 运行期行为与实时更新
- 13. 设备复制与多规则替换模板
- 14. 导入/粘贴外部 XLSX 的操作规范
- 15. 导出策略与文件命名
- 16. 键盘与无障碍规范
- 17. 性能与稳定性要求
- 18. 实施影响与模块落点
- 19. 验收与测试用例
- 20. 风险与对策
- 21. 附录（示例流程与示例数据）

---

## 0. 背景与目标

### 0.1 背景
- 现场调试常见多个同类设备，寄存器地址与数据类型一致，仅设备编号/连接参数不同。
- 主要操作方式：手工录入 + Excel 整列/多列复制粘贴。
- 操作关键点：批量编辑、高效校验、实时观察、避免误配。

### 0.2 目标
- **单表完成**：操作人员在一个表格完成配置与运行观察，避免页面切换。
- **Excel 体验**：可直接粘贴整列/多列；批量填充与批量编辑快捷。
- **强校验**：地址冲突/越界/HMI 重名/类型不匹配必须即时阻断运行。
- **运行期可调**：失焦即生效；配置变化能快速反映在运行结果中。

### 0.3 非目标（明确不做）
- 不做跨设备对比（不引入 TagGroup）。
- 不将通讯采集能力抽为 CLI 或独立服务（保持在 Tauri 内）。
- 不更改冻结 XLSX 表头规范。

### 0.4 成功衡量（建议）
- 300 点位配置完成时间 < 15 分钟（熟练操作）。
- 运行前阻断级错误为 0（全部修复后才能运行）。
- 运行期间可在 2 次编辑内完成“参数调整 → 结果验证”闭环。

---

## 1. 术语与对象

- **设备（Device）**：现场物理设备的逻辑单元，一个设备默认对应一个通讯通道。
- **通道（Channel）**：TCP/485 连接与通讯参数集合（ConnectionProfile）。
- **点位（CommPoint）**：一个变量点的配置与解析规则。
- **HMI 名称**：业务变量名，全局唯一；对外可见/可导出。
- **pointKey**：系统生成稳定键，运行期关联主键，不随 HMI 修改而变。
- **读区（RegisterArea）**：Holding/Input/Coil/Discrete。
- **Human Address**：40001/30001/00001 语义的人工输入地址。
- **绝对地址（0-based）**：内部 Modbus 地址（寄存器/线圈索引）。
- **阻断级错误**：必须修复，否则禁止运行。

---

## 2. 设计原则与硬约束

### 2.1 设计原则
1) **零阻碍操作**：不打断批量录入、粘贴、填充流程。
2) **强校验优先**：错误当场提示，运行前必须为 0。
3) **可解释**：错误必须给出明确原因与定位。
4) **可预期**：表格顺序、地址推断、填充步长均可预测。
5) **实时同屏**：运行结果与配置同屏对照。

### 2.2 硬约束（已拍板）
1) HMI 名称全局唯一（跨设备）。
2) 一设备默认一个通道。
3) 地址输入遵循 4xxxx/3xxxx/0xxxx/1xxxx 语义。
4) 强校验：地址冲突/越界/重名/类型不匹配 → 高亮 + 闪烁 + 明确错误信息，禁止运行。
5) 运行结果必须在同一表格内显示。
6) 运行期编辑：单元格失焦后生效。
7) 导出：每设备一个 `通讯地址表.xlsx`（冻结三表规范不变）。
8) 地址冲突只在**同设备内**判断。
9) 不做跨设备对比功能。

---

## 3. 信息架构与页面布局

### 3.1 总体结构
- 工程列表 → 进入工程 → 设备标签页
- 顶部：全局 Run 状态条（可选 Start All / Stop All / 全局错误数）
- 中部：设备 tabs（每个设备一张表）
- 设备 tab 内：连接配置 + 点位表格 + 运行结果

### 3.2 页面结构示意（文字线框）
```
[Header: 工程名 | 返回工程列表]
[Global Run Bar: Start All | Stop All | 全局错误数 | 最近更新时间]
[Device Tabs: 设备A | 设备B | +新增设备]

[Device Info Bar: 设备名 | 通道 | 读区 | 起始地址 | 长度 | 轮询周期]
[Toolbar: 批量编辑 | 填充地址 | 向下填充 | 清空运行列 | 保存]
[Table: 配置列 + 运行列]
[Error Summary: 错误数量 | 上一个/下一个]
[Run Log (折叠): 最近操作/运行事件]
```

### 3.3 设备 Tab 内布局要求
- 设备信息条保持固定，显示当前上下文（避免误配）。
- 工具条固定在表格上方，保证批量操作可见。
- 运行列必须始终可见（无需跳转页面）。

---

## 4. 设备模型与持久化

### 4.1 设备对象（建议结构）
```json
{
  "deviceId": "uuid",
  "deviceName": "Pump-A",
  "workbookName": "Pump-A",
  "profile": { /* ConnectionProfile */ },
  "points": { /* PointsV1 */ },
  "uiState": { /* 列显示/筛选/批量模板等 */ }
}
```

### 4.2 设备字段约束
- `deviceName`：允许中文/空格，用于 UI 标签。
- `workbookName`：用于导出目录/文件名，需过滤 `/\\:*?"<>|`。
- `profile`：每设备仅一个连接 profile。

### 4.3 项目结构调整建议
- 在 `project.v1.json` 中新增 `devices` 数组（可选字段）。
- 若 `devices` 缺失，则自动兼容为单设备模式。

### 4.4 pointKey 规则
- 手工新增/复制设备：UUID v4。
- 联合表导入：保留 v5 规则（导入后不重写）。

### 4.5 AppData 结构
- `AppData/<app>/projects/<projectId>/comm/`
  - `project.v1.json`（新增 devices）
  - `profiles.v1.json` / `points.v1.json`（legacy 兼容）
  - `runs/<runId>/last_results.v1.json`

---

## 5. 视觉与排版规范（UI 风格）

### 5.1 风格方向
- Swiss Modernism 2.0：规则网格、极简、可读性优先。
- 避免装饰性动效，突出功能性与稳定性。

### 5.2 字体建议
- UI：Fira Sans 或 IBM Plex Sans
- 地址/数值：Fira Code 或 JetBrains Mono

### 5.3 色彩建议
- 主色：#2563EB
- 背景：#F8FAFC
- 文本：#1E293B
- 边框：#E2E8F0
- 错误：#DC2626
- 警告：#F59E0B
- 成功：#16A34A

### 5.4 行高与密度
- 行高 32~36px
- 地址列与数值列使用等宽字体

---

## 6. 表格区域布局与列定义

### 6.1 列分区（固定/滚动）
- **固定左侧（配置核心）**
  - HMI 名称*（必填）
  - Modbus 地址*（必填，40001 语义）
  - 数据类型（枚举）
  - 字节序（枚举）
  - 缩放倍数（数值）

- **中间（可折叠诊断）**
  - 通道名（只读）
  - 绝对地址（0-based，只读）
  - pointKey（高级，只读）

- **固定右侧（运行列）**
  - Quality（只读）
  - Value（只读）
  - Error（只读）
  - Timestamp（只读）
  - ms（只读）

### 6.2 列属性表（示例）
| 列名 | 字段 | 类型 | 默认值 | 校验 | 备注 |
|---|---|---|---|---|---|
| HMI 名称 | hmiName | string | 空 | 必填/全局唯一 | 必填列 |
| Modbus 地址 | modbusAddress | string | 空 | 必填/符合语义 | 40001 形式 |
| 数据类型 | dataType | enum | UInt16 | 与读区匹配 | Bool/Int16/... |
| 字节序 | byteOrder | enum | ABCD | 仅 32-bit 生效 | ABCD/BADC/CDAB/DCBA |
| 缩放倍数 | scale | number | 1 | 有效数字 | 支持小数 |

---

## 7. 编辑与交互细节

### 7.1 编辑规则
- 单元格进入编辑 → 输入 → 失焦触发校验与提交。
- `Esc` 取消当前编辑回滚。
- `Enter` 提交并下移；`Tab` 提交并右移。

### 7.2 变更应用
- 失焦后立即计算校验结果。
- 校验通过 → 更新数据模型 + 若运行中则刷新运行计划。
- 校验失败 → 保持红色闪烁并阻断运行。

---

## 8. Excel 级粘贴与批量操作

### 8.1 粘贴规则
- 单列粘贴 → 仅填充当前列。
- 多列粘贴 → 按列序映射（或弹出映射条确认）。
- 粘贴后立即触发校验，错误单元格标红闪烁。

### 8.2 批量工具条
- **批量设置**：数据类型/字节序/缩放倍数。
- **填充地址**：按数据类型步长递增。
- **向下填充**：同值扩展。

---

## 9. 地址输入语义与推断规则

### 9.1 解析规则
- `4xxxx` → Holding
- `3xxxx` → Input
- `0xxxx` → Coil
- `1xxxx` → Discrete

### 9.2 转换公式
- `absolute0 = inputValue - baseStart`
- baseStart：
  - Holding：40001
  - Input：30001
  - Coil：00001
  - Discrete：10001

### 9.3 数据类型步长
- Bool：1
- Int16/UInt16：1
- Int32/UInt32/Float32：2

---

## 10. 校验规则与阻断逻辑

### 10.1 阻断级错误
- HMI 重名（跨设备）
- 地址冲突（同设备）
- 地址越界（超出 profile 范围）
- 类型与读区不匹配
- 缩放倍数非法

### 10.2 阻断逻辑
- 任何阻断级错误存在时：运行按钮禁用。
- 运行中出现阻断错误：立即停止该设备运行并提示。

---

## 11. 错误提示与闪烁规范

### 11.1 闪烁策略
- 闪烁周期：1.2s（渐变强调）
- 若系统启用“减少动态效果”，则仅红框不闪烁。

### 11.2 错误摘要
- 顶部显示错误数与类型统计。
- 提供“上一条/下一条”快速定位。

---

## 12. 运行期行为与实时更新

### 12.1 启动条件
- 表格中无阻断级错误 → 才允许启动运行。

### 12.2 运行中编辑
- 失焦后校验通过 → 自动更新运行计划。
- 失焦后校验失败 → 暂停该设备运行并提示。

---

## 13. 设备复制与多规则替换模板

### 13.1 复制流程
1) 选择源设备
2) 输入新设备名称
3) 设置多条替换规则（from/to）
4) 预览冲突
5) 确认生成

### 13.2 替换模板
- 多条规则可保存为模板
- 模板为项目级，便于同一工程复用

---

## 14. 导入/粘贴外部 XLSX 操作规范

- 支持从 Excel 整列/整表复制粘贴。
- 若粘贴包含表头，系统应自动识别并忽略。

---

## 15. 导出策略与文件命名

- 每设备导出一个 `通讯地址表.xlsx`
- 路径：`deliveries/{批次}/{deviceName}/通讯地址表.xlsx`
- 文件名冲突时自动追加时间戳

---

## 16. 键盘与无障碍规范

- Ctrl+C / Ctrl+V：复制粘贴
- Ctrl+B：批量新增
- Ctrl+E：批量编辑
- Del：删除选中行
- Ctrl+Z / Ctrl+Y：撤销/重做
- 所有操作必须可用键盘完成

---

## 17. 性能与稳定性要求

- 1000 点位以内流畅滚动与编辑。
- 闪烁效果限制在错误单元格范围。

---

## 18. 实施影响与模块落点

- 前端：设备 tabs + 点位表格逻辑扩展
- 后端：新增设备模型与导出逻辑

---

## 19. 验收与测试用例

- 40001 语义解析正确
- HMI 重名阻断运行
- 地址冲突阻断运行
- 运行期编辑失焦更新
- 设备复制与模板替换可用
- 每设备导出工作簿符合冻结表头

---

## 20. 风险与对策

- 设备复制后易出现 HMI 冲突 → 必须强校验阻断
- 运行期错误导致频繁暂停 → UI 显示明确原因

---

## 21. 附录（示例流程与示例数据）

### 21.1 示例：复制设备
- 源设备：Pump-A
- 新设备：Pump-B
- 替换规则：
  - `PUMP_A_` → `PUMP_B_`
  - `_A_` → `_B_`

---

> 本规范为 v1，后续如新增“对比功能”需另开版本说明。
